<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: rp/passcode.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: rp/passcode.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * PassCode panel.
 * 
 * @module PassCodePanel
 * @return {Object}
 */
define([
  'panels',
  'shared/settings_listener',
],

function(panels, SettingsListener) {
  'use strict';

  function PassCodePanel() {}

  PassCodePanel.prototype = {

    panel: null,

    /**
     * create  : when the user turns on passcode settings
     * edit    : when the user presses edit passcode button
     * confirm : when the user turns off passcode settings
     * new     : when the user is editing passcode
     *                and has entered old passcode successfully
     */
    _MODE: 'create',

    _settings: {
      passcode: '0000'
    },

    _checkingLength: {
      'create': 8,
      'new': 8,
      'edit': 4,
      'confirm': 4,
      'confirmLock': 4
    },

    _passcodeBuffer: '',

    init: function() {
      this.panel = document.getElementById('rp-passcode');
      this._getAllElements();
      this.passcodeInput.addEventListener('keypress', this);
      this.createPasscodeButton.addEventListener('click', this);
      this.changePasscodeButton.addEventListener('click', this);

      // If the pseudo-input loses focus, then allow the user to restore focus
      // by touching the container around the pseudo-input.
      this.passcodeContainer.addEventListener('click', function(evt) {
        this.passcodeInput.focus();
        evt.preventDefault();
      }.bind(this));

      this._fetchSettings();

      this.panel.addEventListener('pagerendered',
        this.onBeforeShow.bind(this));
    },

    /**
     * Re-runs the font-fit title
     * centering logic.
     *
     * The gaia-header has mutation observers
     * that listen for changes in the header
     * title and re-run the font-fit logic.
     *
     * If buttons around the title are shown/hidden
     * then these mutation observers won't be
     * triggered, but we want the font-fit logic
     * to be re-run.
     *
     * This is a deficiency of &lt;gaia-header>. If
     * anyone knows a way to listen for changes
     * in visibility, we won't need this anymore.
     *
     * @param {GaiaHeader} header
     * @private
     */
    runHeaderFontFit: function su_runHeaderFontFit(header) {
      var titles = header.querySelectorAll('h1');
      [].forEach.call(titles, function(title) {
        title.textContent = title.textContent;
      });
    },

    _getAllElements: function sld_getAllElements() {
      this.passcodePanel = this.panel;
      this.header = this.panel.querySelector('header');
      this.passcodeInput = this.panel.querySelector('.passcode-input');
      this.passcodeDigits = this.panel.querySelectorAll('.passcode-digit');
      this.passcodeContainer =
        this.panel.querySelector('.passcode-container');
      this.createPasscodeButton =
        this.panel.querySelector('.passcode-create');
      this.changePasscodeButton =
        this.panel.querySelector('.passcode-change');
    },

    onBeforeShow: function sld_onBeforeShow(event) {
      this._showDialogInMode(event.detail || 'create');
      setTimeout(this.onShow.bind(this), 100);
    },

    onShow: function sld_onShow() {
      this.passcodeInput.focus();
    },

    _showDialogInMode: function sld_showDialogInMode(mode) {
      this._hideErrorMessage();
      this._MODE = mode;
      this.passcodePanel.dataset.mode = mode;
      this._updatePassCodeUI();
      this.runHeaderFontFit(this.header);
    },

    handleEvent: function sld_handleEvent(evt) {
      var settings;
      var passcode;
      var lock;

      switch (evt.target) {
        case this.passcodeInput:
          evt.preventDefault();
          if (this._passcodeBuffer === '') {
            this._hideErrorMessage();
          }

          var code = evt.charCode;
          if (code !== 0 &amp;&amp; (code &lt; 0x30 || code > 0x39)) {
            return;
          }

          var key = String.fromCharCode(code);
          if (evt.charCode === 0) {
            if (this._passcodeBuffer.length > 0) {
              this._passcodeBuffer = this._passcodeBuffer.substring(0,
                this._passcodeBuffer.length - 1);
              if (this.passcodePanel.dataset.passcodeStatus === 'success') {
                this._resetPasscodeStatus();
              }
            }
          } else if (this._passcodeBuffer.length &lt; 8) {
            this._passcodeBuffer += key;
          }

          this._updatePassCodeUI();
          this._enablePasscode();
          break;
        case this.createPasscodeButton:
        case this.changePasscodeButton:
          evt.stopPropagation();
          if (this.passcodePanel.dataset.passcodeStatus !== 'success') {
            this._showErrorMessage();
            this.passcodeInput.focus();
            return;
          }
          passcode = this._passcodeBuffer.substring(0, 4);
          settings = navigator.mozSettings;
          lock = settings.createLock();
          lock.set({
            'lockscreen.passcode-lock.code': passcode
          });
          lock.set({
            'lockscreen.passcode-lock.enabled': true
          });
          this._backToScreenLock();
          break;
      }
    },

    _enablePasscode: function sld_enablePasscode() {
      var settings;
      var passcode;
      var lock;

      if (this._passcodeBuffer.length === this._checkingLength[this._MODE]) {
        switch (this._MODE) {
          case 'create':
          case 'new':
            passcode = this._passcodeBuffer.substring(0, 4);
            var passcodeToConfirm = this._passcodeBuffer.substring(4, 8);
            if (passcode != passcodeToConfirm) {
              this._passcodeBuffer = '';
              this._showErrorMessage();
            } else {
              this._enableButton();
            }
            break;
          case 'confirm':
            if (this._checkPasscode()) {
              settings = navigator.mozSettings;
              lock = settings.createLock();
              lock.set({
                'lockscreen.passcode-lock.enabled': false
              });
              this._backToScreenLock();
            } else {
              this._passcodeBuffer = '';
            }
            break;
          case 'confirmLock':
            if (this._checkPasscode()) {
              settings = navigator.mozSettings;
              lock = settings.createLock();
              lock.set({
                'lockscreen.enabled': false,
                'lockscreen.passcode-lock.enabled': false
              });
              this._backToScreenLock();
            } else {
              this._passcodeBuffer = '';
            }
            break;
          case 'edit':
            if (this._checkPasscode()) {
              this._passcodeBuffer = '';
              this._updatePassCodeUI();
              this._showDialogInMode('new');
            } else {
              this._passcodeBuffer = '';
            }
            break;
        }
      }
    },

    _fetchSettings: function sld_fetchSettings() {
      SettingsListener.observe('lockscreen.passcode-lock.code', '0000',
        function(passcode) {
          this._settings.passcode = passcode;
      }.bind(this));
    },

    _showErrorMessage: function sld_showErrorMessage(message) {
      this.passcodePanel.dataset.passcodeStatus = 'error';
    },

    _hideErrorMessage: function sld_hideErrorMessage() {
      this.passcodePanel.dataset.passcodeStatus = '';
    },

    _resetPasscodeStatus: function sld_resetPasscodeStatus() {
      this.passcodePanel.dataset.passcodeStatus = '';
    },

    _enableButton: function sld_enableButton() {
      this.passcodePanel.dataset.passcodeStatus = 'success';
    },

    _updatePassCodeUI: function sld_updatePassCodeUI() {
      for (var i = 0; i &lt; 8; i++) {
        if (i &lt; this._passcodeBuffer.length) {
          this.passcodeDigits[i].dataset.dot = true;
        } else {
          delete this.passcodeDigits[i].dataset.dot;
        }
      }
    },

    _checkPasscode: function sld_checkPasscode() {
      if (this._settings.passcode != this._passcodeBuffer) {
        this._showErrorMessage();
        return false;
      } else {
        this._hideErrorMessage();
        return true;
      }
    },

    _backToScreenLock: function sld_backToScreenLock() {
      this._passcodeBuffer = '';
      this.passcodeInput.blur();
      panels.show({ id: 'rp-screenlock', back: true });
    }

  };

  return new PassCodePanel();

});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-About.html">About</a></li><li><a href="module-ALADefineCustomLocation.html">ALADefineCustomLocation</a></li><li><a href="module-ALAException.html">ALAException</a></li><li><a href="module-AlaPanel.html">AlaPanel</a></li><li><a href="module-AppList.html">AppList</a></li><li><a href="module-BlurSlider.html">BlurSlider</a></li><li><a href="module-Commands.html">Commands</a></li><li><a href="module-ExceptionsPanel.html">ExceptionsPanel</a></li><li><a href="module-PanelController.html">PanelController</a></li><li><a href="module-PassCodePanel.html">PassCodePanel</a></li><li><a href="module-PassPhrase.html">PassPhrase</a></li><li><a href="module-RootPanel.html">RootPanel</a></li><li><a href="module-RPExecuteCommands.html">RPExecuteCommands</a></li><li><a href="module-RpPanel.html">RpPanel</a></li><li><a href="module-ScreenLockPanel.html">ScreenLockPanel</a></li><li><a href="module-TcAppDetailsPanel.html">TcAppDetailsPanel</a></li><li><a href="module-TcApplicationsPanel.html">TcApplicationsPanel</a></li><li><a href="module-TcPanel.html">TcPanel</a></li><li><a href="module-TcPermDetailsPanel.html">TcPermDetailsPanel</a></li><li><a href="module-TcPermissionsPanel.html">TcPermissionsPanel</a></li></ul><h3>Classes</h3><ul><li><a href="module-ALADefineCustomLocation-init.html">init</a></li><li><a href="module-ALAException-init.html">init</a></li><li><a href="module-ExceptionsPanel-init.html">init</a></li><li><a href="module-RootPanel-init.html">init</a></li><li><a href="module-RpPanel-init.html">init</a></li></ul><h3>Global</h3><ul><li><a href="global.html#requirejs">requirejs</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.1</a> on Tue Jun 23 2015 13:12:29 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
