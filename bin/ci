#! /bin/bash -e

# XXX: At some point we probably don't need travis specific logic but for now
#      it's very easy to use this with environment variables to keep everything
#      running as it does in travis.

# test suite root for all travis ci step style tests...
suite_root="tests/travis_ci"

usage() {
  echo
  echo "  Usage: ./bin/ci [command] [args]"
  echo
  echo "  Commands:"
  echo
  echo "    run <suite> - run a particular test suite (use ls to see all suites)"
  echo "    run-step <suite> <step>"
  echo "    ls - list all the test suites which can be run"
  echo
  echo
}

run_step() {
  local step="$suite_root/$1/$2"
  if [ -x "$step" ];
  then
    . $step
  fi
}

validate_suite() {
  local suite="$1"
  local root="$suite_root/$suite"

  if [  ! -d $root ] || [ "$suite" == "" ] || [ "$suite" == " " ];
  then
    echo "CI suite $suite does not exist in path $root"
    echo
    echo "Allowed suites:"
    echo
    echo "$(cmd_ls)"
    echo
    usage
    exit 1
  fi
}

cmd_ls() {
  ls $suite_root
}

cmd_run_step() {
  local suite=$1
  local step=$2

  validate_suite $suite
  run_step $suite $step
}

cmd_run() {
  validate_suite $suite
  for step in $steps; do
    run_step $suite $step
  done
}

case "$1" in
"run")
  cmd_run ${@:2}
  ;;
"run-step")
  cmd_run_step ${@:2}
  ;;
"ls")
  cmd_ls
  ;;
*)
  usage
  ;;
esac
