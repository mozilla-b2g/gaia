<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
	  <meta name="viewport" content="width=device-width, initial-scale=1.0, min-scale=1.0, max-scale=1.0, user-scalable=no"/>
    <style>
      html, body {
        margin: 0;
        -moz-user-select: none;
        background-color: black;
        font-size: 18px;
        color: white;
        height: 800px;
        width: 480px;
        overflow: hidden;
      }

      #phoneNumberView {
        height: 200px;
        color: white;
        background-image: -moz-linear-gradient(bottom, rgb(33,31,33) 24%, rgb(19,27,19) 74%, rgb(17,17,17) 84%);
        font-size: 4em;
      }

      #keyboard {
        display: -moz-box;
        -moz-box-orient: vertical;
        -moz-box-flex: 1;
        background-image: -moz-linear-gradient(top, rgb(33,31,33) 24%, rgb(79,77,79) 74%, rgb(87,87,87) 84%);
      }
    
      .keyboard-row {
        display: -moz-box;
        -moz-box-orient: horizontal;
        -moz-box-flex: 1;
      }

      .keyboard-key {
        display: -moz-box;
        -moz-appearance: none;
        -moz-box-orient: horizontal;
        -moz-box-flex: 1;

        margin: 5px;
        background: -moz-linear-gradient(top, #353535, #252525 50%, #111111 51%);
        border-radius: 10px;
        border: 1px solid #151515;
        border-top: 1px solid #c3d6df;
        box-shadow: 0 1px 3px black;
      }

      .keyboard-key:hover {
        background: -moz-linear-gradient(top, #555555, #353535 50%, #222222 51%);
      }

      .keyboard-key:hover:active {
        -moz-box-shadow: 0 2px 6px #aaaaaa;
      }

      .keyboard-key > span {
        display: -moz-box;
        pointer-events: none;
        -moz-box-flex: 1;
        -moz-box-pack: center;
        -moz-box-align: center;
      }

      .keyboard-key > span:first-child {
        text-shadow: 1px 1px 0px #000;
        margin-left: 8px;
        font-size: 4em;
        min-width: 40px;
      }

      .keyboard-key > span + span:last-child {
        font-size: 1.5em;
        color: #555;
        text-transform: uppercase;
        text-shadow: 1px 1px 0px rgb(105,105,105);
        min-width: 100px;
      }

      .keyboard-key.call {
        -moz-box-flex: 3;

        background: -moz-linear-gradient(top, #45c545, #35b535 50%, #21a121 51%);
        border-radius: 10px;
        border: 1px solid #454545;
        border-top: 1px solid #c3d6df;
        box-shadow: 0 1px 3px black;
      }

      .keyboard-key.call > span:last-child,
      .keyboard-key.delete > span:last-child {
        color: white;
        font-size: 3em;
      }
    </style>

    <script>
      var KeyHandler = {
        get phoneNumber() {
          delete this.phoneNumber;
          return this.phoneNumber = document.getElementById("phoneNumber");
        },
        
        get phoneNumberView() {
          delete this.phoneNumberView;
          return this.phoneNumberView = document.getElementById("phoneNumberView");
        },

        init: function() {
          this.phoneNumber.value = "";
        },

        isContactShortcut: function (key) {
          // TODO implement key shortcuts
          return false;
        },

        formatPhoneNumber: function(phoneNumber) {
          // TODO implement formatting depending on locale
          return phoneNumber;
        },

        updateFontSize: function() {
          function getNextFontSize(fontSize, text) {
            var div = document.createElement("div");
            div.style.position = "absolute";
            div.style.top = "-1000px";
            div.style.fontSize = fontSize + "px";
            div.innerHTML = text;
            document.body.appendChild(div);

            var kFontStep = 8;
            var windowWidth = document.body.clientWidth;
            var rect = div.getBoundingClientRect();
            if (rect.width > windowWidth) {
              fontSize -= kFontStep;
            } else if (fontSize < kDefaultFontSize) {
              div.style.fontSize = (fontSize + kFontStep) + "px";
              rect = div.getBoundingClientRect();
              if (rect.width <= windowWidth)
                fontSize += kFontStep;
            }

            document.body.removeChild(div);
            return fontSize;
          }

          var view = this.phoneNumberView;
          var computedStyle = window.getComputedStyle(view, null);
          var fontSize = computedStyle.getPropertyValue("font-size");

          var text = this.formatPhoneNumber(this.phoneNumber.value);
          view.innerHTML = text;

          var kDefaultFontSize = 72;
          fontSize = (text) ? getNextFontSize(parseInt(fontSize), text)
                            : kDefaultFontSize;
          view.style.fontSize = fontSize + "px";
        },

        keyDown: function(event) {
          var target = event.target;
          var key = target.getAttribute("value"); 
          if (!key)
            return;

          var callback = function(self) {
            switch (key) {
              case "0":
                self.phoneNumber.value += "+";
                self.updateFontSize();
                self._target = null;
                break;
              case "del":
                self.phoneNumber.value = "";
                self.updateFontSize();
                self._target = null;
                break;
              default:
                if (self.isContactShortcut(key)) {
                  self._target = null;
                  return;
                }
                break;
            }
          };

          KeyHandler._target = target;
          KeyHandler._timeout = window.setTimeout(callback, 400, KeyHandler);
        },

        keyUp: function(event) {
          var char;
          var phoneNumber = KeyHandler.phoneNumber;
          switch (event.type) {
            case "keypress":
              var code = event.charCode;
              if (!code)
                return;

              char = String.fromCharCode(code);
              event.preventDefault();
              break;

            case "mouseup":
              clearTimeout(KeyHandler._timeout);
              var target = KeyHandler._target;
              if (!target)
                return;

              char = target.getAttribute("value");
              if (char == "call") {
                try {
                   window.navigator.mozPhone.call(this.phoneNumber.value);
                } catch (e) {
                   console.log("error calling number: "+ e);
                }
                return;
              } else if (char == "del") {
                // TODO delete at the current position
                phoneNumber.value = phoneNumber.value.slice(0, -1);
                KeyHandler.updateFontSize();
                return;
              }
              break;
          }

          phoneNumber.value += char;
          KeyHandler.updateFontSize();
        }
      };

      window.addEventListener("keypress", KeyHandler.keyup, true);
    </script>
  </head>

  <body onload="KeyHandler.init();">
    <input type="hidden" id="phoneNumber"></input>
    <div id="phoneNumberView"></div>

    <div id="keyboard" onmousedown="KeyHandler.keyDown(event)" onmouseup="KeyHandler.keyUp(event)">
      <div class="keyboard-row">
        <div class="keyboard-key" value="1">
          <span>1</span>
          <span></span>
        </div>
        <div class="keyboard-key" value="2">
          <span>2</span>
          <span>abc</span>
        </div>
        <div class="keyboard-key" value="3">
          <span>3</span>
          <span>def</span>
        </div>
      </div>
      <div class="keyboard-row">
        <div class="keyboard-key" value="4">
          <span>4</span>
          <span>ghi</span>
        </div>
        <div class="keyboard-key" value="5">
          <span>5</span>
          <span>jkl</span>
        </div>
        <div class="keyboard-key" value="6">
          <span>6</span>
          <span>mno</span>
        </div>
      </div>
      <div class="keyboard-row">
        <div class="keyboard-key" value="7">
          <span>7</span>
          <span>pqrs</span>
        </div>
        <div class="keyboard-key" value="8">
          <span>8</span>
          <span>tuv</span>
        </div>
        <div class="keyboard-key" value="9">
          <span>9</span>
          <span>wxyz</span>
        </div>
      </div>
      <div class="keyboard-row">
        <div class="keyboard-key" value="*">
          <span>&#8727;</span>
          <span></span>
        </div>
        <div class="keyboard-key" value="0">
          <span>0</span>
          <span>+</span>
        </div>
        <div class="keyboard-key" value="#">
          <span>#</span>
          <span></span>
        </div>
      </div>
      <div class="keyboard-row">
        <div class="keyboard-key call" value="call">
          <span>&#9742;</span>
        </div>
        <div class="keyboard-key delete" value="del">
          <span>&#8653;</span>
        </div>
      </div>
    </div>
  </body>
</html>
