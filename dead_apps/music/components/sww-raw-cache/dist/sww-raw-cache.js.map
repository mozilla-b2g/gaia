{"version":3,"sources":["node_modules/browserify/node_modules/browser-pack/_prelude.js","index.js","lib/sww-raw-cache.js"],"names":[],"mappings":"AAAA;ACAA;AACA;AACA;AACA;;ACHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"sww-raw-cache.js","sourceRoot":"/source/","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","var RawCache = require('./lib/sww-raw-cache.js');\n\nself.RawCache = RawCache;\n","/* global Response, Request, Promise */\n'use strict';\n\n/**\n * Constructor for the RawCache object. It receives an object\n * with the configuration parameters.\n * @param {Object} options set of configuration parameters.\n */\nfunction RawCache(options) {\n  if (!options.cacheName) {\n    throw Error('This middleware needs a cache name.');\n  }\n\n  this.cacheName = options.cacheName;\n  this.DEFAULT_CONTENT_TYPE = options.defaultContentType || 'text/html';\n}\n\n/**\n * Utility method to retrieve cache used by this middleware.\n * @returns {Promise} promise once resolved will contain the Cache object\n */\nRawCache.prototype._getCache = function getCache() {\n  this._cache = this._cache || self.caches.open(this.cacheName);\n  return this._cache;\n};\n\n// This middleware will support the following http methods\nRawCache.prototype.SUPPORTED_ACTIONS = ['get', 'post', 'put', 'delete'];\n\n/**\n * Handles the request and perform actions over the cache content\n * based on the http verb used for the request.\n * @param {Request} the request object.\n * @param {Response} the response object.\n * @param {Function} the callback to finalize the fetching pipeline.\n */\nRawCache.prototype.onFetch = function onFetch(request, response, endWith) {\n  if (response) {\n    return Promise.resolve(response);\n  }\n\n  var method = request.method.toLowerCase();\n  if (this.SUPPORTED_ACTIONS.indexOf(method) === -1) {\n    // Method not supported, just bypass the request and do nothing\n    // in this layer\n    return null;\n  }\n\n  return this[method].apply(this, [request, response, endWith]);\n};\n\n/**\n * Get the content from this cache.\n * @param {Request} request the request object.\n * @param {Response} response the response object.\n * @returns {Promise} Promise with the response object cached or null\n */\nRawCache.prototype.get = function get(request, response, endWith) {\n  var _this = this;\n  return _this._getCache().then(function(cache) {\n    return cache.match(request).then(function (response) {\n      if (!response) { return null; }\n      return endWith(response);\n    });\n  });\n};\n\n/**\n * Removes the specified uri from the cache entry\n * @param {Request} request the request object.\n * @param {Response} response the response object.\n * @returns {Promise} Promise, result of removing from cache.\n */\nRawCache.prototype.delete = function del(request) {\n  var _this = this;\n  return this._getCache().then(function(cache) {\n    return cache.delete(request).then(\n      _this._getOKResponse,\n      _this._getErrorResponse\n    );\n  });\n};\n\n/**\n * Adds the body of the specified request as a cache entry for the uri\n * in the request.\n * @param {Request} request the request object.\n * @param {Response} response the response object.\n * @returns {Promise} Promise, 200 response if cached correctly.\n */\nRawCache.prototype.post = function post(request) {\n  var _this = this;\n  request = request.clone();\n  return request.text().then(function(content) {\n    var contentType =\n      request.headers.get('Content-Type') || _this.DEFAULT_CONTENT_TYPE;\n    var response = new Response(content, {\n      'headers': {\n      \t'x-sww-raw-cache': _this.cacheName + ';time=' + Date.now(),\n      \t'Content-Type': contentType\n      }\n    });\n    // We create a new request, with default GET method\n    var customRequest = new Request(request.url);\n    return _this._getCache().then(function(cache) {\n      return cache.put(customRequest, response).then(\n        _this._getOKResponse,\n        _this._getErrorResponse\n      );\n    });\n  });\n};\n\n// In this version put and post work in the same way, this could change\n// in future versions.\nRawCache.prototype.put = RawCache.prototype.post;\n\n/**\n * Builds a 200 response to be returned when operations against the cache\n * are performed without problems.\n * @param (string) msg optional message\n * @returns (Response) response object\n */\nRawCache.prototype._getOKResponse = function(msg) {\n  return RawCache._getResponse(200, {\n    'status': 'ok',\n    'msg': msg\n  });\n};\n\n/**\n * Builds a 500 response to be returned when operations against the cache\n * are performed with problems.\n * @param (string) msg optional message\n * @returns (Response) response object\n */\nRawCache.prototype._getErrorResponse = function(msg) {\n  return RawCache._getResponse(500, {\n    'status': 'ko',\n    'msg': msg\n  });\n};\n\n/**\n * Builds a generic response.\n */\nRawCache._getResponse = function(statusNumber, content) {\n  return new Response(JSON.stringify(content), {\n    'headers': { 'Content-Type': 'application/json' },\n    'status': statusNumber\n  });\n};\n\nmodule.exports = RawCache;\n"]}