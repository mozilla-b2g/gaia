<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: transfer.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: transfer.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* -*- Mode: js; js-indent-level: 2; indent-tabs-mode: nil -*- */
/* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab: */

'use strict';
/* global gDeviceList */

navigator.mozL10n.once(function showPanel() {
  var settings = window.navigator.mozSettings;
  var bluetooth = window.navigator.mozBluetooth;
  var defaultAdapter = null;
  var activity = null;
  var sendingFilesSchedule = {};
  var numberOfTasks;
  var _debug = false;

  navigator.mozSetMessageHandler('activity', function handler(activityRequest) {
    activity = activityRequest;
    if (settings &amp;&amp; bluetooth &amp;&amp;
        (activity.source.name == 'share' ||
         activity.source.name == 'share-via-bluetooth-only') &amp;&amp;
        (activity.source.data.blobs &amp;&amp;
         activity.source.data.blobs.length > 0)) {
      observeOnadapteradded();
      observeBluetoothEnabled();
      isBluetoothEnabled();
    } else {
      var msg = 'Cannot transfer without blobs data!';
      cannotTransfer(msg);
    }
  });

  var dialogConfirmBluetooth =
    document.getElementById('enable-bluetooth-view');
  var bluetoothCancelButton =
    document.getElementById('enable-bluetooth-button-cancel');
  var bluetoothTurnOnButton =
    document.getElementById('enable-bluetooth-button-turn-on');
  var dialogAlertView = document.getElementById('alert-view');
  var alertOkButton = document.getElementById('alert-button-ok');

  function debug(msg) {
    if (!_debug) {
      return;
    }

    console.log('[Bluetooth APP Send File]: ' + msg);
  }

  function observeOnadapteradded() {
    bluetooth.onadapteradded = function bt_adapterAdded() {
      initialDefaultAdapter();
    };
  }

  function observeBluetoothEnabled() {
    // enable Bluetooth if the related settings says so
    // register an observer to monitor bluetooth.enabled changes
    settings.addObserver('bluetooth.enabled', function(event) {
      var enabled = event.settingValue;
      var msg = 'bluetooth.enabled = ' + enabled;
      debug(msg);

      // clear deviceList and defaultAdapter,
      // we have to acquire it again when enabled.
      if (!enabled) {
        msg = 'clear deviceList and defaultAdapter';
        debug(msg);
        gDeviceList.update(false);
        defaultAdapter = null;

        // Make sure turn Bluetooth on confirmation dialog is hidden or not,
        // Then, require user to confirm for turn Bluetooth on again.
        if (dialogConfirmBluetooth.hidden) {
          msg = 'require user to confirm for turn Bluetooth on';
          debug(msg);
          confirmTurnBluetoothOn();
        }
      } else {
        dialogConfirmBluetooth.hidden = true;
      }
    });
  }

  function isBluetoothEnabled() {
    // get bluetooth status
    var req = settings.createLock().get('bluetooth.enabled');
    req.onsuccess = function bt_EnabledSuccess() {
      if (req.result['bluetooth.enabled']) {
        initialDefaultAdapter();
      } else {
        confirmTurnBluetoothOn();
      }
    };
    req.onerror = function bt_EnabledOnerror() {
      var msg = 'Can not get bluetooth.enabled from setting!';
      cannotTransfer(msg);
    };
  }

  function confirmTurnBluetoothOn() {
    dialogConfirmBluetooth.hidden = false;
    bluetoothCancelButton.addEventListener('click', cancelTransfer);
    bluetoothTurnOnButton.addEventListener('click', turnOnBluetooth);
  }

  function turnOnBluetooth(evt) {
    if (evt) {
      evt.preventDefault();
    }

    dialogConfirmBluetooth.hidden = true;
    settings.createLock().set({'bluetooth.enabled': true});
  }

  function initialDefaultAdapter(callback) {
    if (!bluetooth.enabled) {
      return;
    }

    var req = bluetooth.getDefaultAdapter();
    req.onsuccess = function bt_getAdapterSuccess() {
      defaultAdapter = req.result;
      if (defaultAdapter == null) {
        // we can do nothing without DefaultAdapter, so set bluetooth disabled
        settings.createLock().set({'bluetooth.enabled': false});
        var msg = 'Get null bluetooth adapter!';
        cannotTransfer(msg);
        return;
      }
      if (callback) {
        callback();
      }
      defaultAdapter.ondevicefound = gDeviceList.onDeviceFound;

      // initial related components that need defaultAdapter.
      // Set callback function for selected device, exit devices list view
      gDeviceList.initWithAdapter(defaultAdapter,
                                  transferToDevice, cancelTransfer);
      gDeviceList.update(true);
    };
    req.onerror = function bt_getAdapterFailed() {
      // we can do nothing without DefaultAdapter, so set bluetooth disabled
      settings.createLock().set({'bluetooth.enabled': false});
      var msg = 'Can not get bluetooth adapter!';
      cannotTransfer(msg);
    };
  }

  function cancelTransfer(evt) {
    if (evt) {
      evt.preventDefault();
    }

    dialogConfirmBluetooth.hidden = true;
    gDeviceList.uninit();
    activity.postError('cancelled');
    endTransfer();
  }

  function cannotTransfer(msg) {
    debug(msg);
    dialogAlertView.hidden = false;
    alertOkButton.addEventListener('click', closeAlert);
  }

  function closeAlert() {
    dialogAlertView.hidden = true;
    alertOkButton.removeEventListener('click', closeAlert);
    activity.postError('cancelled');
    endTransfer();
  }

  function endTransfer() {
    bluetoothCancelButton.removeEventListener('click', cancelTransfer);
    bluetoothTurnOnButton.removeEventListener('click', turnOnBluetooth);
    activity = null;
  }

  function transferToDevice(device) {
    var targetDevice = device;

    // Post message to system app for sending files in queue
    // Producer: Bluetooth app produce one message for each sending file request
    sendingFilesSchedule = {
      numberOfFiles: activity.source.data.blobs.length,
      numSuccessful: 0,
      numUnsuccessful: 0
    };
    postMessageToSystemApp(sendingFilesSchedule);

    // Send each file via Bluetooth sendFile API
    var blobs = activity.source.data.blobs;
    numberOfTasks = blobs.length;
    blobs.forEach(function(blob, index) {
      /**
       * Checking blob.name is because the sendFile() api needs a "file" object.
       * And it is needing a filaname before send it.
       * If there is no filename in the blob, Bluetooth API will give a default
       * name "Unknown.jpeg". So Bluetooth app have to find out the name via
       * device stroage.
       */
      if (blob.name) {
        // The blob has name, send the blob directly.
        debug('blob is sending with name...');
        sendFile(targetDevice.address, blob);
      } else if (activity.source.data.filepaths) {
        // The blob does not have name,
        // browse the file via filepath from storage again.
        var filepath = activity.source.data.filepaths[index];
        var storage = navigator.getDeviceStorage('sdcard');
        var getRequest = storage.get(filepath);

        getRequest.onsuccess = function() {
          debug('getFile succeed &amp; file is sending...');
          sendFile(targetDevice.address, getRequest.result);
        };

        getRequest.onerror = function() {
          debug('getFile failed so that blob is sending without filename ' +
                getRequest.error &amp;&amp; getRequest.error.name);
          sendFile(targetDevice.address, blob);
        };
      } else {
        // The blob does not have name and filepath,
        // pass the blob without name to send file directly.
        debug('no filepath to get from device storage ' +
              'so that blob is sending without filename');
        sendFile(targetDevice.address, blob);
      }
    });
  }

  /**
   * Given address, blob(file), message to send file via platform.
   *
   * @access private
   * @memberOf transfer
   * @param {String} address - address of target device
   * @param {Object} blob - blob(file) to send
   */
  function sendFile(address, blob) {
    defaultAdapter.sendFile(address, blob);
    checkTasksComplete();
  }

  function checkTasksComplete() {
    if (--numberOfTasks === 0) {
      transferred();
    }
  }

  function transferred() {
    activity.postResult('transferred');
    endTransfer();
  }

  // Inner app communcation:
  function postMessageToSystemApp(sendingFilesSchedule) {
    // Set up Inter-App Communications
    navigator.mozApps.getSelf().onsuccess = function gotSelf(evt) {
      var app = evt.target.result;
      // If IAC doesn't exist, just bail out.
      if (!app.connect) {
        sendingFilesSchedule = {};
        return;
      }

      app.connect('bluetoothTransfercomms').then(function(ports) {
        ports.forEach(function(port) {
          port.postMessage(sendingFilesSchedule);
          var msg = 'post message to system app...';
          debug(msg);
        });
        sendingFilesSchedule = {};
      });
    };
  }
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-bluetooth_bt_template_factory.html">bluetooth/bt_template_factory</a></li><li><a href="module-BluetoothAdapterManager.html">BluetoothAdapterManager</a></li><li><a href="module-BluetoothClassOfDeviceMapper.html">BluetoothClassOfDeviceMapper</a></li><li><a href="module-BluetoothConnectionManager.html">BluetoothConnectionManager</a></li><li><a href="module-BluetoothContext.html">BluetoothContext</a></li><li><a href="module-BluetoothDevice.html">BluetoothDevice</a></li><li><a href="module-modules_bluetooth_version_detector.html">modules/bluetooth/version_detector</a></li></ul><h3>Classes</h3><ul><li><a href="module-BluetoothDevice-BluetoothDevice.html">BluetoothDevice</a></li></ul><h3>Global</h3><ul><li><a href="global.html#requirejs">requirejs</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.1</a> on Thu Jul 23 2015 17:05:22 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
