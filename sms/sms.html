<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en'>
  <head>
	  <meta name='viewport' content='width=device-width, initial-scale=1.0, min-scale=1.0, max-scale=1.0, user-scalable=no'/>
    <script type="text/javascript" src="sms.js"></script>
    <style>
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: white;
        -moz-user-select: none;
        font-family: sans-serif;
        overflow: hidden;
        font-size: 20px;
      }

      #header {
        background: -moz-linear-gradient(top, #c0c0c0, #a0a0a0);
        color: white;
        font-weight: bold;
        padding-left: 1mozmm;
        height: 26px;
        line-height: 26px;
      }

      #messages {
        height: -moz-calc(100% - 26px);
        overflow: hidden;
      }

      #messages[panning] {
        image-rendering: optimizeSpeed;
        text-rendering: optimizeSpeed;
      }

      .message {
        padding: 0 10px;
        border-bottom: 1px solid lightgrey;
      }

      .message * {
        pointer-events: none;
      }

      .message.receive {
        background-color: lightyellow;
      }

      .message.new {
        font-weight: bold;
      }

      .sms {
        background: url(missing.png) no-repeat 0 0;
        background-size: 96px 96px;
        background-position: -10px;
        display: inline-block;
        padding-left: 96px;
        height: 96px;
        width: 100%;
        white-space: nowrap;
      }

      .title,
      .content {
        line-height: 48px;
        height: 40px;
        margin: 0px;
        padding: 0px;
      }

      .title {
        font-size: 1.5em;
      }

      .text {
        display: inline-block;
        width: 336px;
        width: -moz-calc(100% - 96px);
        text-overflow: ellipsis;
        overflow: hidden;
        vertical-align: middle;
      }

      .infos {
        display: block;
        width: -moz-calc(100% - 96px);
        font-size: 14px;
        line-height: 14px;
        font-weight: bold;
        text-align: right;
        color: grey;
      }
    </style>

    <script>
      var MessageView = {
        init: function init() {
          this.showConversations();

          var view = this.view;
          view.addEventListener('touchstart', this, true);
          view.addEventListener('mousedown', this, true);
          window.addEventListener('touchmove', this, true);
          window.addEventListener('mousemove', this, true);
          window.addEventListener('touchend', this, true);
          window.addEventListener('mouseup', this, true);
          window.addEventListener('smsreceived', this, true);
          window.addEventListener('smssent', this, true);
        },

        get conversationView() {
          delete this.conversationView;
          return this.conversationView = document.getElementById('conversation');
        },

        openConversationView: function openConversationView(num) {
          var url = 'sms/sms_conversation.html';
          if (num)
            url += '?' + num;
          window.top.openApplication(url);
        },

        get view() {
          delete this.view;
          return this.view = document.getElementById('messages');
        },

        showConversations: function showConversations() {
          var self = this;
          MessageManager.getMessages(function(messages) {
            var conversations = {};
            for (var i = 0; i < messages.length; i++) {
              var message = messages[i];
              var sender = message.sender || message.receiver;
              if (conversations[sender]) {
                conversations[sender].count++;
                continue;
              }

              conversations[sender] = {
                sender: message.sender,
                receiver: message.receiver,
                body: message.body,
                timestamp: prettyDate(message.timestamp),
                count: 1
              }
            }

            while (self.view.childNodes.length > 2)
              self.view.removeChild(self.view.lastChild);

            var fragment = document.createDocumentFragment();
            for (var conversation in conversations) {
              var msg = self.createNewMessage(conversations[conversation]);
              fragment.appendChild(msg);
            }
            self.view.appendChild(fragment);
          }, null);
        },

        createNewMessage: function createNewMessage(message) {
          var container = document.createElement('div');
          container.className = 'message';

          var content = document.createElement('div');
          content.className = 'sms';

          var contact = document.createElement('div');
          var num = message.sender;
          if (!num) {
            num = message.receiver;
            container.className = 'message receive';
          }
          container.setAttribute('num', num);

          container.onclick = function (evt) {
            MessageView.openConversationView(evt.target.getAttribute('num'));
          };

          var title = num + ' (' + message.count + ')';
          contact.appendChild(document.createTextNode(title));
          contact.className = 'title';
          content.appendChild(contact);
        
          var sms = document.createElement('div');
          sms.className = 'content';

          var text = document.createElement('span');
          text.appendChild(document.createTextNode(message.body));
          text.className = 'text';
          sms.appendChild(text);

          var infos = document.createElement('span');
          infos.appendChild(document.createTextNode(message.timestamp));
          infos.className = 'infos';
          sms.appendChild(infos);
          content.appendChild(sms);

          container.appendChild(content);
          return container;
        },

        onTouchStart: function onTouchStart(evt) {
          this.start = evt.pageY;
          this.panning = true;
          this.view.setAttribute('panning', 'true');
        },

        onTouchMove: function onTouchMove(evt) {
          if (!this.panning)
            return;

          var offset = evt.pageY - this.start;
          this.start = evt.pageY;
          this.view.scrollTop -= offset;
        },

        onTouchEnd: function onTouchEnd(evt) {
          if (!this.panning)
            return;

          var offset = evt.pageY - this.start;
          this.view.scrollTop -= offset;
          this.panning = false;
          this.view.removeAttribute('panning');
        },

        handleEvent: function handleEvent(evt) {
          switch (evt.type) {
            case 'touchstart':
              event.preventDefault();
            case 'mousedown':
              this.onTouchStart(evt.touches ? evt.touches[0] : evt);
              break;
            case 'touchmove':
              event.preventDefault();
            case 'mousemove':
              this.onTouchMove(evt.touches ? evt.touches[0] : evt);
              break;
            case 'touchend':
              event.preventDefault();
            case 'mouseup':
              this.onTouchEnd(evt.touches ? evt.touches[0] : evt);
              break;
            case 'smssent':
            case 'smsreceived':
              setTimeout(function(self) {
                self.showConversations();
              }, 800, this);
              break;
          }
        }
      };
    </script>
  </head>

  <body onload='MessageView.init();'>
    <div id='header'>SMS</div>
    <div id='messages'>
      <div class='message' onclick='MessageView.openConversationView();'>
        <div class='title'>New Message</div>
        <div class='content'>Write a message</div>
      </div>
    </div>
  </body>
</html>
