<!DOCTYPE html>
<html>
  <head>
    <style>
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: white;
        -moz-user-select: none;
        font-family: sans-serif;
        overflow: hidden;
        font-size: 20px;
      }

      #conversation {
        color: black;
      }

      input, textarea {
        -moz-appearance: none;
        -moz-box-sizing: border-box;
        border-width: 2px;
        border-style: solid;
        border-color: lightgrey;
        font-size: 24px;
        margin: 1mozmm 0.4mozmm 1mozmm 0.4mozmm;
        padding-left: 1mozmm;
        padding-right: 1mozmm;
        border-radius: 0.5mozmm;
      }

      input,
      textarea {
        height: 64px;
      }

      textarea {
        padding-top: 16px;
        resize: none;
      }

      input:focus,
      textarea:focus {
        border-color: orange;
      }

      #contact {
        width: -moz-calc(100% - 0.8mozmm);
      }

      #contact.known {
        padding-top: 0px;
        visibility: hidden;
        height: 0;
      }

      #message-content {
        width: -moz-calc(100% - 0.8mozmm);
        position: absolute;
        bottom: 0px;
      }

      #message-content * {
        vertical-align: top;
      }

      #message {
        width: -moz-calc(100% - 100px);
        max-height: 400px;
        min-height: 64px;
        overflow: hidden;
      }

      #message-send {
        float: right;
      }

      #throbber {
        position: absolute;
        height: 100%;
        width: 100%;
        background-color: rgba(0,0,0,0.3);
        z-index: 1;
      }

      #throbber img {
        margin-top: -moz-calc(50% - 16px);
        margin-left: -moz-calc(50% - 16px);
      }

      .message {
        padding: 0 10px;
        border-bottom: 1px solid lightgrey;
      }

      .message * {
        pointer-events: none;
      }

      .message.receive {
        background-color: lightyellow;
      }

      .message.new {
        font-weight: bold;
      }

      .sms {
        display: inline-block;
        height: 64px;
        width: 100%;
      }

      .content {
        line-height: 48px;
        height: 40px;
        margin: 0px;
        padding: 0px;
        font-size: 1.5em;
      }

      .text {
        display: inline-block;
        width: 100%;
        vertical-align: middle;
      }

      .infos {
        display: block;
        width: 100%;
        font-size: 14px;
        line-height: 14px;
        font-weight: bold;
        text-align: right;
        color: grey;
      }
    </style>
    <script>
      // Based on Resig's pretty date
      function prettyDate(time) {
        var diff = (Date.now() - time) / 1000;
        var day_diff = Math.floor(diff / 86400);
      
        if (isNaN(day_diff) || day_diff < 0 || day_diff >= 31)
          return;
      
        return day_diff == 0 && (
                diff < 60 && "just now" ||
                diff < 120 && "1 minute ago" ||
                diff < 3600 && Math.floor( diff / 60 ) + " minutes ago" ||
                diff < 7200 && "1 hour ago" ||
                diff < 86400 && Math.floor( diff / 3600 ) + " hours ago") ||
                day_diff == 1 && "Yesterday" ||
                day_diff < 7 && day_diff + " days ago" ||
                day_diff < 31 && Math.ceil( day_diff / 7 ) + " weeks ago";
      };

      function startup() {
        var num = document.location.toString().split('?')[1];
        if (!num)
          return;

        var contact = document.getElementById('contact');
        contact.classList.toggle('known');
        contact.value = num;

        window.addEventListener('smssent', retrieveAndShow, true);
        window.addEventListener('smsreceived', retrieveAndShow, true);

        retrieveAndShow();
      }

      function retrieveAndShow() {
        var num = document.location.toString().split('?')[1];
        var view = document.getElementById('conversation');
        while (view.childNodes.length > 2)
          view.removeChild(view.lastChild);

        var messages = [];
        if (('mozSms' in navigator) && num) {
          var filter = new SmsFilter();
          filter.number = num;
          var request = navigator.mozSms.getMessages(filter ,true);
          request.onsuccess = function() {
            var result = request.result;
            if (!result) {
              showMessages(messages);
              return;
            }
            
            var message = result.message;
            messages.push(message);
            result.next();
          };

          request.onerror = function() {
            alert('Something wrong has happened while reading the database. Error code: ' + request.errorCode);
          }
        } else {
          showMessages(messages);
        }
      }

      function showMessages(messages) {
        var view = document.getElementById('conversation');
        for (var i = 0; i < messages.length; i++) {
          var message = messages[i];
          var container = document.createElement('div');
          container.className = 'message';

          var content = document.createElement('div');
          content.className = 'sms';

          var contact = document.createElement('div');
          var num = message.sender;
          if (!num) {
            num = message.receiver;
            container.className = 'message receive';
          }
          container.setAttribute('num', num);

          var sms = document.createElement('div');
          sms.className = 'content';

          var text = document.createElement('span');
          text.appendChild(document.createTextNode(message.body));
          text.className = 'text';
          sms.appendChild(text);

          var infos = document.createElement('span');
          infos.appendChild(document.createTextNode(prettyDate(message.timestamp)));
          infos.className = 'infos';
          sms.appendChild(infos);
          content.appendChild(sms);

          container.appendChild(content);
          view.appendChild(container);
        }
      }
    
      function onKeyPress(evt) {
        var target = evt.originalTarget;
        setTimeout(function() {
          target.style.height = '';
          target.style.height = '-moz-calc(' + target.scrollHeight + 'px + 32px)';
        }, 0);
      }

      function send() {
        function close() {
          contact.value = msg.value = '';
          msg.style.height = '';
          document.getElementById('throbber').setAttribute('hidden', 'true');

          var num = document.location.toString().split('?')[1];
          if (!num) {
            var event = document.createEvent("UIEvents");
            event.initUIEvent("appclose", true, true, window, 1);
            window.top.dispatchEvent(event);
          }
        }

        var throbber = document.getElementById('throbber');
        throbber.removeAttribute('hidden');

        var contact = document.getElementById('contact');
        var msg = document.getElementById('message');
        if (contact.value == '')
          return;

        if ('mozSms' in navigator) {
          var result = navigator.mozSms.send(contact.value, msg.value);
          result.onsuccess = close;
          result.onerror = close;
        } else {
          setTimeout(function() {
            var windows = window.top.document.getElementById('windows');
            parentWindow = windows.lastChild.previousSibling.contentWindow;

            var event = document.createEvent("CustomEvent");
            var message = {
              sender: null,
              receiver: contact.value,
              body: msg.value,
              timestamp: Date.now()
            }
            event.initCustomEvent("smssent", true, false, message);
            parentWindow.dispatchEvent(event);
            close();
          }, 1000);
        }
      }
    </script>
  </head>
  <body onload='startup()'>
    <div id='throbber' hidden='true'>
      <img src='../images/throbber.png' width='32' height='32'></img>
    </div>

    <form onsubmit='send(); return false;'>
      <div id='conversation'>
        <input id='contact' type='tel' required='true' placeholder='To:' list='contacts'></input>
        <datalist id='contacts'>
          <option value='Andreas Gal'></option>
          <option value='Chris Jones'></option>
          <option value='Mom Zilla'></option>
          <option value='Mounir Lamouri'></option>
          <option value='Trace Monkey'></option>
          <option value='Jaeger Monkey'></option>
          <option value='Ion Monkey'></option>
        </datalist>
      </div>

      <div id='message-content'>
        <textarea id='message' type='textbox' placeholder='Type your message' onkeypress='onKeyPress(event);'></textarea>
        <input id='message-send' type='submit' value='Send'></input>
      </div>
    </form>
  </body>
</html>
