(function(window) {

  var worker;

  worker = new TestAgent.BrowserWorker({
    sandbox: './sandbox.html'
  });

  worker.use(TestAgent.BrowserWorker.PostMessage);

  worker.use(TestAgent.BrowserWorker.MochaDriver, {
    mochaUrl: '/mocha/mocha.js',
    testHelperUrl: '/test/helper.js'
  });

  worker.use(TestAgent.BrowserWorker.ErrorReporting);
  worker.addTestsProcessor(function(tests) {
    var domain = window.location.host.split('.')[0];
    return tests.map(function(file) {
      var url = file.split('/');
      url.splice(2, 0, domain);
      return url.join('/');
    });
  });

  var oldEmit = worker.emit;

  worker.emit = function() {
    //console.log(arguments);
    oldEmit.apply(this, arguments);
  };

  worker.on({

    'sandbox': function() {
      worker.loader.require('/vendor/expect.js');
    },

    'open': function() {
      console.log('socket open');
    },

    'close': function() {
      console.log('lost client trying to reconnect');
    }

  });

  worker.start();

}(this));
