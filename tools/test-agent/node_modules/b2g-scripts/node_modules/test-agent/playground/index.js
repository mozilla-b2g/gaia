(function(window) {

  var worker;

  worker = new TestAgent.BrowserWorker();

  worker.use(TestAgent.BrowserWorker.Websocket);

  worker.use(TestAgent.BrowserWorker.Config, {
    url: '/playground/config.json'
  });

  worker.use(TestAgent.BrowserWorker.MultiDomainDriver, {
    groupTestsByDomain: function(test) {
      var split = test.split('/'),
          domainPart = split.shift(),
          domain,
          test = '/playground/' + split.join('/');

      domain = 'http://' + domainPart + '.gaiamobile.org:';
      domain += String(window.location.port);
      domain += '/playground/' + domainPart + '/index.html';

      return {
        domain: domain,
        test: test,
        env: domainPart
      };
    }
  });

  worker.use(TestAgent.BrowserWorker.TestUi);
  worker.use(TestAgent.BrowserWorker.ErrorReporting);
  worker.use(TestAgent.Common.MochaTestEvents, {
    defaultMochaReporter: 'HTML'
  });

  worker.on({

    'test data': function() {
    },

    'sandbox': function() {
      worker.loader.require('/vendor/expect.js');
    },

    'open': function() {
      console.log('socket open');
    },

    'close': function() {
      console.log('lost client trying to reconnect');
    }

  });

  worker.config();
  worker.start();

}(this));
