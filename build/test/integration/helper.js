var assert = require('chai').assert;
var fs = require('fs');
var AdmZip = require('adm-zip');

function getPrefsSandbox() {
  var sandbox = {
    prefs: {},
    userPrefs: {},

    user_pref: function(key, value) {
      sandbox.userPrefs[key] = value;
    },

    pref: function(key, value) {
      sandbox.prefs[key] = value;
    }
  };
  return sandbox;
}

function checkError(error, stdout, stderr) {
  if (error) {
    console.log('stdout: ' + stdout);
    console.log('stderr: ' + stderr);
    console.log('error: ' + error);
  }
  assert.equal(error, null);
}

function checkSettings(settings, expectedSettings) {
  Object.keys(expectedSettings).forEach(function(key) {
    assert.isDefined(settings[key], 'key ' + key + ' is defined');
    assert.deepEqual(expectedSettings[key], settings[key],
      'value of settings key ' + key + ' equal ' + expectedSettings[key]);
  });
}

function checkPrefs(actual, expected) {
  Object.keys(expected).forEach(function(key) {
    assert.isDefined(actual[key], 'key ' + key + ' is defined');
    assert.deepEqual(actual[key], expected[key], 'value of settings key ' +
      key + ' equal ' + expected[key]);
  });
}

function checkWebappsScheme(webapps) {
  Object.keys(webapps).forEach(function(key) {
    var webapp = webapps[key];
    var scheme =
      webapp.origin.indexOf('mochi.test') !== -1 ||
      webapp.origin.indexOf('marketplace.allizom.org') !== -1 ||
      webapp.origin.indexOf('inapp-pay-test.paas.allizom.org') !== -1 ?
      'http' : 'app';
    assert.equal(webapp.origin.indexOf(scheme), 0);
  });
}

function checkFileInZip(zipPath, pathInZip, expectedPath) {
  var expected = fs.readFileSync(expectedPath);
  checkFileContentInZip(zipPath, pathInZip, expected);
}

function checkFileContentInZip(zipPath, pathInZip, expectedContent, isJSON) {
  var zip = new AdmZip(zipPath);
  var entry = zip.getEntry(pathInZip);
  var actual = isJSON ? JSON.parse(zip.readAsText(entry)) : zip.readFile(entry);
  assert.deepEqual(actual, expectedContent);
}

function checkFileContentInZip(zipPath, pathInZip, expectedContent, isJSON) {
  var zip = new AdmZip(zipPath);
  var entry = zip.getEntry(pathInZip);
  var actual = isJSON ? JSON.parse(zip.readAsText(entry)) : zip.readFile(entry);
  assert.deepEqual(actual, expectedContent);
}

exports.getPrefsSandbox = getPrefsSandbox;
exports.checkError = checkError;
exports.checkSettings = checkSettings;
exports.checkPrefs = checkPrefs;
exports.checkWebappsScheme = checkWebappsScheme;
exports.checkFileInZip = checkFileInZip;
exports.checkFileContentInZip = checkFileContentInZip;
