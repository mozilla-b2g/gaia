#! /bin/bash -e

source ./bin/buildbot_step

Xvfb :0 -nolisten tcp -screen 0 1600x1200x24 2>/dev/null &
export DISPLAY=:0

checkout_path="$PWD/git_checkout"

# Run the checkout to the correct url, etc...
step_checkout() {
 tc-vcs \
  checkout \
  $checkout_path \
  $GAIA_BASE_REPOSITORY \
  $GAIA_HEAD_REPOSITORY \
  $GAIA_REV \
  $GAIA_REF 
}

# Set-up our npm-cache.
step_npm_cache() {
  taskcluster-npm-cache-get --namespace gaia.npm_cache ./package.json
}

buildbot_step 'git checkout' step_checkout

# From here on we to operate inside of the actual checkout mostly for
# convenience.
cd $checkout_path

# Current revision...
buildbot_step 'git revision...' git --no-pager log -n 1

# node modules
buildbot_step 'npm-cache-get' step_npm_cache

# virtualenv setup so any python packages can be abused without root access
buildbot_step 'virtualenv' virtualenv $HOME/.venv --system-site-packages
source $HOME/.venv/bin/activate

# run whatever command was intended on the branch (root of the repo)
buildbot_step "run $*" $@
