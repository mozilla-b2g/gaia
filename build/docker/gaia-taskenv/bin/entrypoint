#! /bin/bash -ex

export DISPLAY=:99
Xvfb :99 > /dev/null 2>&1 &

checkout_path="$PWD/git_checkout"

# Run the checkout...

if [ "$GITHUB_PULL_REQUEST" == "1" ];
then
  time git ci-checkout-ref \
    $checkout_path \
    $GITHUB_BASE_GIT \
    $GITHUB_BASE_REV \
    $GITHUB_HEAD_GIT \
    $GITHUB_HEAD_REV
else
  time git ci-checkout-ref $checkout_path $GITHUB_HEAD_GIT $GITHUB_HEAD_REV
fi

cd $checkout_path

# Current revision...
git log -n 1

# virtualenv setup so any python packages can be abused without root access
virtualenv $HOME/.venv --system-site-packages
source $HOME/.venv/bin/activate

# run whatever command was intended on the branch (root of the repo)
eval $@
