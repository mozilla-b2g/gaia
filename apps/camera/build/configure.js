var fs = require('fs');
var maxImagePixelSize = 5 * 1024 * 1024;

var gaiaDistributionDirectory = process.env.GAIA_DISTRIBUTION_DIR;
var configurationObject = {};
var configurationFile;

var generateConfigurationFile = function() {

  maxImagePixelSize = (configurationObject &&
                       configurationObject.maxImagePixelSize) ||
                       maxImagePixelSize;
  var content =
    '// This file is automatically generated: DO NOT EDIT.\n' +
    '// To change this value, create a camera.json file in the\n' +
    '// distribution directory with content like this: \n' +
    '//   { "maxImagePixelSize": 6000000 }\n' +
    'var CONFIG_MAX_IMAGE_PIXEL_SIZE = ' + maxImagePixelSize + ';';

  fs.writeFile('js/config.js', content, function(err) {
    if (err) {
        console.log(err);
    } else {
        console.log('Configuration file has been generated: js/config.js');
    }
  });

};

if (gaiaDistributionDirectory) {
  fs.readFile(gaiaDistributionDirectory + '/camera.json',
              'utf8', function(err, data) {
    if (err) {
      if (err.code === 'ENOENT') {
        console.log('The configuration file :' + gaiaDistributionDirectory +
                    '/camera.json doesn\'t exist');
      } else {
        return console.log(err);
      }
    } else {
      configurationObject = JSON.parse(data);
    }
    generateConfigurationFile();
  });
} else {
  generateConfigurationFile();
}
