<!DOCTYPE html>  <html> <head>   <title>jskanji.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               jskanji.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>TODO current bugs
1. little case hiragana cannot convert to katakana 
2. return does not work in select mode
3. getSuggestion</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>IME special key code map
see <code>layout.js</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">IMESpecialKey</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">BACK</span><span class="o">:</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span>
    <span class="nx">PREVIOUS</span><span class="o">:</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span>
    <span class="nx">NEXT</span><span class="o">:</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span>
    <span class="nx">MARK</span><span class="o">:</span> <span class="o">-</span><span class="mi">13</span><span class="p">,</span>
    <span class="nx">TRANSFORM</span><span class="o">:</span> <span class="o">-</span><span class="mi">14</span><span class="p">,</span>
    <span class="nx">CASE_CHANGE</span><span class="o">:</span> <span class="o">-</span><span class="mi">16</span><span class="p">,</span>
    <span class="nx">FULL</span><span class="o">:</span> <span class="o">-</span><span class="mi">17</span><span class="p">,</span>
    <span class="nx">H2K</span><span class="o">:</span> <span class="o">-</span><span class="mi">18</span><span class="p">,</span>
    <span class="nx">EN_LAYOUT</span><span class="o">:</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span>
    <span class="nx">NUM_LAYOUT</span><span class="o">:</span> <span class="o">-</span><span class="mi">21</span><span class="p">,</span>
    <span class="nx">BASIC_LAYOUT</span><span class="o">:</span> <span class="o">-</span><span class="mi">22</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Keyboard mode mapping
FIXME partly used, maybe remove used</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">IMEMode</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">FULL_HIRAGANA</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">FULL_KATAKANA</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">FULL_ALPHABET</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="nx">FULL_NUMBER</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="nx">HALF_NUMBER</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="nx">HALF_ALPHABET</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="nx">HALF_KATAKANA</span><span class="o">:</span> <span class="mi">6</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">IMEKeyMap</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;あ&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;か&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;さ&#39;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;た&#39;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;な&#39;</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;は&#39;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;ま&#39;</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;や&#39;</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;ら&#39;</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;わ&#39;</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;、&#39;</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;ア&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;カ&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;サ&#39;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;タ&#39;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;ナ&#39;</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;ハ&#39;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;マ&#39;</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;ヤ&#39;</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;ラ&#39;</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;ワ&#39;</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span>
    <span class="s1">&#39;ｱ&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ｶ&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ｻ&#39;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;ﾀ&#39;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;ﾅ&#39;</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;ﾊ&#39;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;ﾏ&#39;</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;ﾔ&#39;</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;ﾗ&#39;</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;ﾜ&#39;</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;､&#39;</span><span class="o">:</span> <span class="mi">10</span>
  <span class="p">};</span> </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Key loop
Ex.
  あ displays when clicking あ
  い displays when clicking あ twice</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">IMEHiraganaCycleTable</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;あ&#39;</span><span class="p">,</span> <span class="s1">&#39;い&#39;</span><span class="p">,</span> <span class="s1">&#39;う&#39;</span><span class="p">,</span> <span class="s1">&#39;え&#39;</span><span class="p">,</span> <span class="s1">&#39;お&#39;</span><span class="p">,</span> <span class="s1">&#39;ぁ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぃ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぅ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぇ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぉ&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;か&#39;</span><span class="p">,</span> <span class="s1">&#39;き&#39;</span><span class="p">,</span> <span class="s1">&#39;く&#39;</span><span class="p">,</span> <span class="s1">&#39;け&#39;</span><span class="p">,</span> <span class="s1">&#39;こ&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;さ&#39;</span><span class="p">,</span> <span class="s1">&#39;し&#39;</span><span class="p">,</span> <span class="s1">&#39;す&#39;</span><span class="p">,</span> <span class="s1">&#39;せ&#39;</span><span class="p">,</span> <span class="s1">&#39;そ&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;た&#39;</span><span class="p">,</span> <span class="s1">&#39;ち&#39;</span><span class="p">,</span> <span class="s1">&#39;つ&#39;</span><span class="p">,</span> <span class="s1">&#39;て&#39;</span><span class="p">,</span> <span class="s1">&#39;と&#39;</span><span class="p">,</span> <span class="s1">&#39;っ&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;な&#39;</span><span class="p">,</span> <span class="s1">&#39;に&#39;</span><span class="p">,</span> <span class="s1">&#39;ぬ&#39;</span><span class="p">,</span> <span class="s1">&#39;ね&#39;</span><span class="p">,</span> <span class="s1">&#39;の&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;は&#39;</span><span class="p">,</span> <span class="s1">&#39;ひ&#39;</span><span class="p">,</span> <span class="s1">&#39;ふ&#39;</span><span class="p">,</span> <span class="s1">&#39;へ&#39;</span><span class="p">,</span> <span class="s1">&#39;ほ&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;ま&#39;</span><span class="p">,</span> <span class="s1">&#39;み&#39;</span><span class="p">,</span> <span class="s1">&#39;む&#39;</span><span class="p">,</span> <span class="s1">&#39;め&#39;</span><span class="p">,</span> <span class="s1">&#39;も&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;や&#39;</span><span class="p">,</span> <span class="s1">&#39;ゆ&#39;</span><span class="p">,</span> <span class="s1">&#39;よ&#39;</span><span class="p">,</span> <span class="s1">&#39;ゃ&#39;</span><span class="p">,</span> <span class="s1">&#39;ゅ&#39;</span><span class="p">,</span> <span class="s1">&#39;ょ&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;ら&#39;</span><span class="p">,</span> <span class="s1">&#39;り&#39;</span><span class="p">,</span> <span class="s1">&#39;る&#39;</span><span class="p">,</span> <span class="s1">&#39;れ&#39;</span><span class="p">,</span> <span class="s1">&#39;ろ&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;わ&#39;</span><span class="p">,</span> <span class="s1">&#39;を&#39;</span><span class="p">,</span> <span class="s1">&#39;ん&#39;</span><span class="p">,</span> <span class="s1">&#39;ゎ&#39;</span><span class="p">,</span> <span class="s1">&#39;ー&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;、&#39;</span><span class="p">,</span> <span class="s1">&#39;。&#39;</span><span class="p">,</span> <span class="s1">&#39;？&#39;</span><span class="p">,</span> <span class="s1">&#39;！&#39;</span><span class="p">,</span> <span class="s1">&#39;・&#39;</span><span class="p">,</span> <span class="s1">&#39;　&#39;</span><span class="p">]</span>
  <span class="p">];</span>
  <span class="kd">var</span> <span class="nx">IMEFullKatakanaCycleTable</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;ア&quot;</span><span class="p">,</span> <span class="s2">&quot;イ&quot;</span><span class="p">,</span> <span class="s2">&quot;ウ&quot;</span><span class="p">,</span> <span class="s2">&quot;エ&quot;</span><span class="p">,</span> <span class="s2">&quot;オ&quot;</span><span class="p">,</span> <span class="s2">&quot;ァ&quot;</span><span class="p">,</span> <span class="s2">&quot;ィ&quot;</span><span class="p">,</span> <span class="s2">&quot;ゥ&quot;</span><span class="p">,</span> <span class="s2">&quot;ェ&quot;</span><span class="p">,</span> <span class="s2">&quot;ォ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;カ&quot;</span><span class="p">,</span> <span class="s2">&quot;キ&quot;</span><span class="p">,</span> <span class="s2">&quot;ク&quot;</span><span class="p">,</span> <span class="s2">&quot;ケ&quot;</span><span class="p">,</span> <span class="s2">&quot;コ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;サ&quot;</span><span class="p">,</span> <span class="s2">&quot;シ&quot;</span><span class="p">,</span> <span class="s2">&quot;ス&quot;</span><span class="p">,</span> <span class="s2">&quot;セ&quot;</span><span class="p">,</span> <span class="s2">&quot;ソ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;タ&quot;</span><span class="p">,</span> <span class="s2">&quot;チ&quot;</span><span class="p">,</span> <span class="s2">&quot;ツ&quot;</span><span class="p">,</span> <span class="s2">&quot;テ&quot;</span><span class="p">,</span> <span class="s2">&quot;ト&quot;</span><span class="p">,</span> <span class="s2">&quot;ッ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ナ&quot;</span><span class="p">,</span> <span class="s2">&quot;ニ&quot;</span><span class="p">,</span> <span class="s2">&quot;ヌ&quot;</span><span class="p">,</span> <span class="s2">&quot;ネ&quot;</span><span class="p">,</span> <span class="s2">&quot;ノ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ハ&quot;</span><span class="p">,</span> <span class="s2">&quot;ヒ&quot;</span><span class="p">,</span> <span class="s2">&quot;フ&quot;</span><span class="p">,</span> <span class="s2">&quot;ヘ&quot;</span><span class="p">,</span> <span class="s2">&quot;ホ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;マ&quot;</span><span class="p">,</span> <span class="s2">&quot;ミ&quot;</span><span class="p">,</span> <span class="s2">&quot;ム&quot;</span><span class="p">,</span> <span class="s2">&quot;メ&quot;</span><span class="p">,</span> <span class="s2">&quot;モ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ヤ&quot;</span><span class="p">,</span> <span class="s2">&quot;ユ&quot;</span><span class="p">,</span> <span class="s2">&quot;ヨ&quot;</span><span class="p">,</span> <span class="s2">&quot;ャ&quot;</span><span class="p">,</span> <span class="s2">&quot;ュ&quot;</span><span class="p">,</span> <span class="s2">&quot;ョ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ラ&quot;</span><span class="p">,</span> <span class="s2">&quot;リ&quot;</span><span class="p">,</span> <span class="s2">&quot;ル&quot;</span><span class="p">,</span> <span class="s2">&quot;レ&quot;</span><span class="p">,</span> <span class="s2">&quot;ロ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ワ&quot;</span><span class="p">,</span> <span class="s2">&quot;ヲ&quot;</span><span class="p">,</span> <span class="s2">&quot;ン&quot;</span><span class="p">,</span> <span class="s2">&quot;ヮ&quot;</span><span class="p">,</span> <span class="s2">&quot;ー&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;。&quot;</span><span class="p">,</span> <span class="s2">&quot;？&quot;</span><span class="p">,</span> <span class="s2">&quot;！&quot;</span><span class="p">,</span> <span class="s2">&quot;・&quot;</span><span class="p">,</span> <span class="s2">&quot;　&quot;</span><span class="p">]</span>
  <span class="p">];</span>
  <span class="kd">var</span> <span class="nx">IMEHalfKatakanaCycleTable</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;ｱ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｲ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｳ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｴ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｵ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｧ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｨ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｩ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｪ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｫ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ｶ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｷ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｸ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｹ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｺ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ｻ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｼ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｽ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｾ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｿ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ﾀ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾁ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾂ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾃ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾄ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｯ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ﾅ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾆ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾇ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾈ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾉ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ﾊ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾋ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾌ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾍ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾎ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ﾏ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾐ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾑ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾒ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾓ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ﾔ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾕ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾖ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｬ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｭ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｮ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ﾗ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾘ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾙ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾚ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾛ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ﾜ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｦ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾝ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｰ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;､&quot;</span><span class="p">,</span> <span class="s2">&quot;｡&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;･&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">]</span>
  <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Hiragana (平假名) case convert table</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">HiraganaCaseTable</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;あ&#39;</span><span class="o">:</span> <span class="s1">&#39;ぁ&#39;</span><span class="p">,</span> <span class="s1">&#39;い&#39;</span><span class="o">:</span> <span class="s1">&#39;ぃ&#39;</span><span class="p">,</span> <span class="s1">&#39;う&#39;</span><span class="o">:</span> <span class="s1">&#39;ぅ&#39;</span><span class="p">,</span> <span class="s1">&#39;え&#39;</span><span class="o">:</span> <span class="s1">&#39;ぇ&#39;</span><span class="p">,</span> <span class="s1">&#39;お&#39;</span><span class="o">:</span> <span class="s1">&#39;ぉ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぁ&#39;</span><span class="o">:</span> <span class="s1">&#39;あ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぃ&#39;</span><span class="o">:</span> <span class="s1">&#39;い&#39;</span><span class="p">,</span> <span class="s1">&#39;ぅ&#39;</span><span class="o">:</span> <span class="s1">&#39;ヴ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぇ&#39;</span><span class="o">:</span> <span class="s1">&#39;え&#39;</span><span class="p">,</span> <span class="s1">&#39;ぉ&#39;</span><span class="o">:</span> <span class="s1">&#39;お&#39;</span><span class="p">,</span> <span class="s1">&#39;か&#39;</span><span class="o">:</span> <span class="s1">&#39;が&#39;</span><span class="p">,</span> <span class="s1">&#39;き&#39;</span><span class="o">:</span> <span class="s1">&#39;ぎ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;く&#39;</span><span class="o">:</span> <span class="s1">&#39;ぐ&#39;</span><span class="p">,</span> <span class="s1">&#39;け&#39;</span><span class="o">:</span> <span class="s1">&#39;げ&#39;</span><span class="p">,</span> <span class="s1">&#39;こ&#39;</span><span class="o">:</span> <span class="s1">&#39;ご&#39;</span><span class="p">,</span> <span class="s1">&#39;が&#39;</span><span class="o">:</span> <span class="s1">&#39;か&#39;</span><span class="p">,</span> <span class="s1">&#39;ぎ&#39;</span><span class="o">:</span> <span class="s1">&#39;き&#39;</span><span class="p">,</span> <span class="s1">&#39;ぐ&#39;</span><span class="o">:</span> <span class="s1">&#39;く&#39;</span><span class="p">,</span> <span class="s1">&#39;げ&#39;</span><span class="o">:</span> <span class="s1">&#39;け&#39;</span><span class="p">,</span> <span class="s1">&#39;ご&#39;</span><span class="o">:</span> <span class="s1">&#39;こ&#39;</span><span class="p">,</span> <span class="s1">&#39;さ&#39;</span><span class="o">:</span> <span class="s1">&#39;ざ&#39;</span><span class="p">,</span> <span class="s1">&#39;し&#39;</span><span class="o">:</span> <span class="s1">&#39;じ&#39;</span><span class="p">,</span> <span class="s1">&#39;す&#39;</span><span class="o">:</span> <span class="s1">&#39;ず&#39;</span><span class="p">,</span> <span class="s1">&#39;せ&#39;</span><span class="o">:</span> <span class="s1">&#39;ぜ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;そ&#39;</span><span class="o">:</span> <span class="s1">&#39;ぞ&#39;</span><span class="p">,</span> <span class="s1">&#39;ざ&#39;</span><span class="o">:</span> <span class="s1">&#39;さ&#39;</span><span class="p">,</span> <span class="s1">&#39;じ&#39;</span><span class="o">:</span> <span class="s1">&#39;し&#39;</span><span class="p">,</span> <span class="s1">&#39;ず&#39;</span><span class="o">:</span> <span class="s1">&#39;す&#39;</span><span class="p">,</span> <span class="s1">&#39;ぜ&#39;</span><span class="o">:</span> <span class="s1">&#39;せ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぞ&#39;</span><span class="o">:</span> <span class="s1">&#39;そ&#39;</span><span class="p">,</span> <span class="s1">&#39;た&#39;</span><span class="o">:</span> <span class="s1">&#39;だ&#39;</span><span class="p">,</span> <span class="s1">&#39;ち&#39;</span><span class="o">:</span> <span class="s1">&#39;ぢ&#39;</span><span class="p">,</span> <span class="s1">&#39;つ&#39;</span><span class="o">:</span> <span class="s1">&#39;っ&#39;</span><span class="p">,</span> <span class="s1">&#39;て&#39;</span><span class="o">:</span> <span class="s1">&#39;で&#39;</span><span class="p">,</span> <span class="s1">&#39;と&#39;</span><span class="o">:</span> <span class="s1">&#39;ど&#39;</span><span class="p">,</span> <span class="s1">&#39;だ&#39;</span><span class="o">:</span> <span class="s1">&#39;た&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ぢ&#39;</span><span class="o">:</span> <span class="s1">&#39;ち&#39;</span><span class="p">,</span> <span class="s1">&#39;っ&#39;</span><span class="o">:</span> <span class="s1">&#39;づ&#39;</span><span class="p">,</span> <span class="s1">&#39;で&#39;</span><span class="o">:</span> <span class="s1">&#39;て&#39;</span><span class="p">,</span> <span class="s1">&#39;ど&#39;</span><span class="o">:</span> <span class="s1">&#39;と&#39;</span><span class="p">,</span> <span class="s1">&#39;づ&#39;</span><span class="o">:</span> <span class="s1">&#39;つ&#39;</span><span class="p">,</span> <span class="s1">&#39;ヴ&#39;</span><span class="o">:</span> <span class="s1">&#39;う&#39;</span><span class="p">,</span> <span class="s1">&#39;は&#39;</span><span class="o">:</span> <span class="s1">&#39;ば&#39;</span><span class="p">,</span> <span class="s1">&#39;ひ&#39;</span><span class="o">:</span> <span class="s1">&#39;び&#39;</span><span class="p">,</span> <span class="s1">&#39;ふ&#39;</span><span class="o">:</span> <span class="s1">&#39;ぶ&#39;</span><span class="p">,</span> <span class="s1">&#39;へ&#39;</span><span class="o">:</span> <span class="s1">&#39;べ&#39;</span><span class="p">,</span> <span class="s1">&#39;ほ&#39;</span><span class="o">:</span> <span class="s1">&#39;ぼ&#39;</span><span class="p">,</span> <span class="s1">&#39;ば&#39;</span><span class="o">:</span> <span class="s1">&#39;ぱ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;び&#39;</span><span class="o">:</span> <span class="s1">&#39;ぴ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぶ&#39;</span><span class="o">:</span> <span class="s1">&#39;ぷ&#39;</span><span class="p">,</span> <span class="s1">&#39;べ&#39;</span><span class="o">:</span> <span class="s1">&#39;ぺ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぼ&#39;</span><span class="o">:</span> <span class="s1">&#39;ぽ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぱ&#39;</span><span class="o">:</span> <span class="s1">&#39;は&#39;</span><span class="p">,</span> <span class="s1">&#39;ぴ&#39;</span><span class="o">:</span> <span class="s1">&#39;ひ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぷ&#39;</span><span class="o">:</span> <span class="s1">&#39;ふ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぺ&#39;</span><span class="o">:</span> <span class="s1">&#39;へ&#39;</span><span class="p">,</span> <span class="s1">&#39;ぽ&#39;</span><span class="o">:</span> <span class="s1">&#39;ほ&#39;</span><span class="p">,</span> <span class="s1">&#39;や&#39;</span><span class="o">:</span> <span class="s1">&#39;ゃ&#39;</span><span class="p">,</span> <span class="s1">&#39;ゆ&#39;</span><span class="o">:</span> <span class="s1">&#39;ゅ&#39;</span><span class="p">,</span> <span class="s1">&#39;よ&#39;</span><span class="o">:</span> <span class="s1">&#39;ょ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ゃ&#39;</span><span class="o">:</span> <span class="s1">&#39;や&#39;</span><span class="p">,</span> <span class="s1">&#39;ゅ&#39;</span><span class="o">:</span> <span class="s1">&#39;ゆ&#39;</span><span class="p">,</span> <span class="s1">&#39;ょ&#39;</span><span class="o">:</span> <span class="s1">&#39;よ&#39;</span><span class="p">,</span> <span class="s1">&#39;わ&#39;</span><span class="o">:</span> <span class="s1">&#39;ゎ&#39;</span><span class="p">,</span> <span class="s1">&#39;ゎ&#39;</span><span class="o">:</span> <span class="s1">&#39;わ&#39;</span><span class="p">,</span> <span class="s1">&#39;゛&#39;</span><span class="o">:</span> <span class="s1">&#39;゜&#39;</span><span class="p">,</span> <span class="s1">&#39;゜&#39;</span><span class="o">:</span> <span class="s1">&#39;゛&#39;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Katakana (片假名) case convert table</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">IMEFullKatakanaCaseTable</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ア&#39;</span><span class="o">:</span> <span class="s1">&#39;ァ&#39;</span><span class="p">,</span> <span class="s1">&#39;イ&#39;</span><span class="o">:</span> <span class="s1">&#39;ィ&#39;</span><span class="p">,</span> <span class="s1">&#39;ウ&#39;</span><span class="o">:</span> <span class="s1">&#39;ゥ&#39;</span><span class="p">,</span> <span class="s1">&#39;エ&#39;</span><span class="o">:</span> <span class="s1">&#39;ェ&#39;</span><span class="p">,</span> <span class="s1">&#39;オ&#39;</span><span class="o">:</span> <span class="s1">&#39;ォ&#39;</span><span class="p">,</span> <span class="s1">&#39;ァ&#39;</span><span class="o">:</span> <span class="s1">&#39;ア&#39;</span><span class="p">,</span> <span class="s1">&#39;ィ&#39;</span><span class="o">:</span> <span class="s1">&#39;イ&#39;</span><span class="p">,</span> <span class="s1">&#39;ゥ&#39;</span><span class="o">:</span> <span class="s1">&#39;ヴ&#39;</span><span class="p">,</span> <span class="s1">&#39;ェ&#39;</span><span class="o">:</span> <span class="s1">&#39;エ&#39;</span><span class="p">,</span> <span class="s1">&#39;ォ&#39;</span><span class="o">:</span> <span class="s1">&#39;オ&#39;</span><span class="p">,</span> <span class="s1">&#39;カ&#39;</span><span class="o">:</span> <span class="s1">&#39;ガ&#39;</span><span class="p">,</span> <span class="s1">&#39;キ&#39;</span><span class="o">:</span> <span class="s1">&#39;ギ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ク&#39;</span><span class="o">:</span> <span class="s1">&#39;グ&#39;</span><span class="p">,</span> <span class="s1">&#39;ケ&#39;</span><span class="o">:</span> <span class="s1">&#39;ゲ&#39;</span><span class="p">,</span> <span class="s1">&#39;コ&#39;</span><span class="o">:</span> <span class="s1">&#39;ゴ&#39;</span><span class="p">,</span> <span class="s1">&#39;ガ&#39;</span><span class="o">:</span> <span class="s1">&#39;カ&#39;</span><span class="p">,</span> <span class="s1">&#39;ギ&#39;</span><span class="o">:</span> <span class="s1">&#39;キ&#39;</span><span class="p">,</span> <span class="s1">&#39;グ&#39;</span><span class="o">:</span> <span class="s1">&#39;ク&#39;</span><span class="p">,</span> <span class="s1">&#39;ゲ&#39;</span><span class="o">:</span> <span class="s1">&#39;ケ&#39;</span><span class="p">,</span> <span class="s1">&#39;ゴ&#39;</span><span class="o">:</span> <span class="s1">&#39;コ&#39;</span><span class="p">,</span> <span class="s1">&#39;サ&#39;</span><span class="o">:</span> <span class="s1">&#39;ザ&#39;</span><span class="p">,</span> <span class="s1">&#39;シ&#39;</span><span class="o">:</span> <span class="s1">&#39;ジ&#39;</span><span class="p">,</span> <span class="s1">&#39;ス&#39;</span><span class="o">:</span> <span class="s1">&#39;ズ&#39;</span><span class="p">,</span> <span class="s1">&#39;セ&#39;</span><span class="o">:</span> <span class="s1">&#39;ゼ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ソ&#39;</span><span class="o">:</span> <span class="s1">&#39;ゾ&#39;</span><span class="p">,</span> <span class="s1">&#39;ザ&#39;</span><span class="o">:</span> <span class="s1">&#39;サ&#39;</span><span class="p">,</span> <span class="s1">&#39;ジ&#39;</span><span class="o">:</span> <span class="s1">&#39;シ&#39;</span><span class="p">,</span> <span class="s1">&#39;ズ&#39;</span><span class="o">:</span> <span class="s1">&#39;ス&#39;</span><span class="p">,</span> <span class="s1">&#39;ゼ&#39;</span><span class="o">:</span> <span class="s1">&#39;セ&#39;</span><span class="p">,</span> <span class="s1">&#39;ゾ&#39;</span><span class="o">:</span> <span class="s1">&#39;ソ&#39;</span><span class="p">,</span> <span class="s1">&#39;タ&#39;</span><span class="o">:</span> <span class="s1">&#39;ダ&#39;</span><span class="p">,</span> <span class="s1">&#39;チ&#39;</span><span class="o">:</span> <span class="s1">&#39;ヂ&#39;</span><span class="p">,</span> <span class="s1">&#39;ツ&#39;</span><span class="o">:</span> <span class="s1">&#39;ッ&#39;</span><span class="p">,</span> <span class="s1">&#39;テ&#39;</span><span class="o">:</span> <span class="s1">&#39;デ&#39;</span><span class="p">,</span> <span class="s1">&#39;ト&#39;</span><span class="o">:</span> <span class="s1">&#39;ド&#39;</span><span class="p">,</span> <span class="s1">&#39;ダ&#39;</span><span class="o">:</span> <span class="s1">&#39;タ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ヂ&#39;</span><span class="o">:</span> <span class="s1">&#39;チ&#39;</span><span class="p">,</span> <span class="s1">&#39;ッ&#39;</span><span class="o">:</span> <span class="s1">&#39;ヅ&#39;</span><span class="p">,</span> <span class="s1">&#39;デ&#39;</span><span class="o">:</span> <span class="s1">&#39;テ&#39;</span><span class="p">,</span> <span class="s1">&#39;ド&#39;</span><span class="o">:</span> <span class="s1">&#39;ト&#39;</span><span class="p">,</span> <span class="s1">&#39;ヅ&#39;</span><span class="o">:</span> <span class="s1">&#39;ツ&#39;</span><span class="p">,</span> <span class="s1">&#39;ヴ&#39;</span><span class="o">:</span> <span class="s1">&#39;ウ&#39;</span><span class="p">,</span> <span class="s1">&#39;ハ&#39;</span><span class="o">:</span> <span class="s1">&#39;バ&#39;</span><span class="p">,</span> <span class="s1">&#39;ヒ&#39;</span><span class="o">:</span> <span class="s1">&#39;ビ&#39;</span><span class="p">,</span> <span class="s1">&#39;フ&#39;</span><span class="o">:</span> <span class="s1">&#39;ブ&#39;</span><span class="p">,</span> <span class="s1">&#39;ヘ&#39;</span><span class="o">:</span> <span class="s1">&#39;ベ&#39;</span><span class="p">,</span> <span class="s1">&#39;ホ&#39;</span><span class="o">:</span> <span class="s1">&#39;ボ&#39;</span><span class="p">,</span> <span class="s1">&#39;バ&#39;</span><span class="o">:</span> <span class="s1">&#39;パ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ビ&#39;</span><span class="o">:</span> <span class="s1">&#39;ピ&#39;</span><span class="p">,</span> <span class="s1">&#39;ブ&#39;</span><span class="o">:</span> <span class="s1">&#39;プ&#39;</span><span class="p">,</span> <span class="s1">&#39;ベ&#39;</span><span class="o">:</span> <span class="s1">&#39;ペ&#39;</span><span class="p">,</span> <span class="s1">&#39;ボ&#39;</span><span class="o">:</span> <span class="s1">&#39;ポ&#39;</span><span class="p">,</span> <span class="s1">&#39;パ&#39;</span><span class="o">:</span> <span class="s1">&#39;ハ&#39;</span><span class="p">,</span> <span class="s1">&#39;ピ&#39;</span><span class="o">:</span> <span class="s1">&#39;ヒ&#39;</span><span class="p">,</span> <span class="s1">&#39;プ&#39;</span><span class="o">:</span> <span class="s1">&#39;フ&#39;</span><span class="p">,</span> <span class="s1">&#39;ペ&#39;</span><span class="o">:</span> <span class="s1">&#39;ヘ&#39;</span><span class="p">,</span> <span class="s1">&#39;ポ&#39;</span><span class="o">:</span> <span class="s1">&#39;ホ&#39;</span><span class="p">,</span> <span class="s1">&#39;ヤ&#39;</span><span class="o">:</span> <span class="s1">&#39;ャ&#39;</span><span class="p">,</span> <span class="s1">&#39;ユ&#39;</span><span class="o">:</span> <span class="s1">&#39;ュ&#39;</span><span class="p">,</span> <span class="s1">&#39;ヨ&#39;</span><span class="o">:</span> <span class="s1">&#39;ョ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ャ&#39;</span><span class="o">:</span> <span class="s1">&#39;ヤ&#39;</span><span class="p">,</span> <span class="s1">&#39;ュ&#39;</span><span class="o">:</span> <span class="s1">&#39;ユ&#39;</span><span class="p">,</span> <span class="s1">&#39;ョ&#39;</span><span class="o">:</span> <span class="s1">&#39;ヨ&#39;</span><span class="p">,</span> <span class="s1">&#39;ワ&#39;</span><span class="o">:</span> <span class="s1">&#39;ヮ&#39;</span><span class="p">,</span> <span class="s1">&#39;ヮ&#39;</span><span class="o">:</span> <span class="s1">&#39;ワ&#39;</span>
  <span class="p">};</span>
  <span class="kd">var</span> <span class="nx">IMEHalfKatakanaCaseTable</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ｱ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｧ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ｲ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｨ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ｳ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｩ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ｴ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｪ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ｵ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｫ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｧ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｱ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ｨ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｲ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ｩ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｳﾞ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ｪ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｴ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ｫ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｵ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｶ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｶﾞ&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;ｷ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｷﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｸ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｸﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｹ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｹﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｺ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｺﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｶﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｶ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｷﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｷ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｸﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｸ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｹﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｹ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｺﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｺ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｻ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｻﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｼ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｼﾞ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ｽ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｽﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｾ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｾﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｿ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｿﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｻﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｻ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｼﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｼ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｽﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｽ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｾﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｾ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｿﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｿ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾀ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾀﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾁ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾁﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾂ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｯ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ﾃ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾃﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾄ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾄﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾀﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾀ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾁﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾁ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｯ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾂﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾃﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾃ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾄﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾄ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾂﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾂ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾊ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾊﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾋ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾋﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾌ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾌﾞ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ﾍ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾍﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾎ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾎﾞ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾊﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾊﾟ&quot;</span><span class="p">,</span><span class="s2">&quot;ﾋﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾋﾟ&quot;</span><span class="p">,</span><span class="s2">&quot;ﾌﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾌﾟ&quot;</span><span class="p">,</span><span class="s2">&quot;ﾍﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾍﾟ&quot;</span><span class="p">,</span><span class="s2">&quot;ﾎﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾎﾟ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾊﾟ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾊ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾋﾟ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾋ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾌﾟ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾌ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾍﾟ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾍ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ﾎﾟ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾎ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾔ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｬ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ﾕ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｭ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ﾖ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｮ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｬ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾔ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ｭ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾕ&quot;</span><span class="p">,</span>  <span class="s2">&quot;ｮ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾖ&quot;</span><span class="p">,</span> <span class="s2">&quot;ﾜ&quot;</span><span class="o">:</span> <span class="s2">&quot;ﾜ&quot;</span><span class="p">,</span> <span class="s2">&quot;ｳﾞ&quot;</span><span class="o">:</span> <span class="s2">&quot;ｳ&quot;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Get key info accoring to previous key and current key
If current key is the first element of a line
  and previous key is in the same line,
  the next key after previous key returns
Otherwise, current key returns</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">getNextKeyInfo</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_getNextKeyInfo</span><span class="p">(</span><span class="nx">prevK</span><span class="p">,</span> <span class="nx">currK</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">IMEHiraganaCycleTable</span><span class="p">[</span><span class="nx">IMEKeyMap</span><span class="p">[</span><span class="nx">currK</span><span class="p">]];</span>
    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> 
    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">prevK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">true</span><span class="p">,</span> <span class="nx">line</span><span class="p">[(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="nx">len</span><span class="p">]];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="kc">false</span><span class="p">,</span> <span class="nx">currK</span><span class="p">];</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>see <code>getNextKeyInfo</code>
only get key in the reverse way</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">getPreviousKeyInfo</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_getPreviousKeyInfo</span><span class="p">(</span><span class="nx">currK</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">outer_len</span> <span class="o">=</span> <span class="nx">IMEHiraganaCycleTable</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">inner_len</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">line</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">outer_len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">line</span> <span class="o">=</span> <span class="nx">IMEHiraganaCycleTable</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">inner_len</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">inner_len</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">===</span> <span class="nx">curr</span><span class="p">){</span>
          <span class="k">return</span> <span class="p">[</span><span class="kc">true</span><span class="p">,</span> <span class="nx">line</span><span class="p">[(</span><span class="nx">j</span><span class="o">+</span><span class="nx">inner_len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="nx">inner_len</span><span class="p">]];</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">[</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">getPosInfoByChar</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_getPosInfoByChar</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">table</span> <span class="o">=</span> <span class="nx">IMEHiraganaCycleTable</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">table</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">table</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">table</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">===</span> <span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">[</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>This is a simple Japanese IME implementation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">IMEngine</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>keep a local copy</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Glue contains some callback functions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_glue</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Query dict</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_dict</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Enable IndexedDB</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_enableIndexedDB</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Max length to predict</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_dictMaxPredictLength</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Input buffer
NOTICE <code>_inputBuf</code> only contains Hiragana</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_inputBuf</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Candidate list to be displayed
candidate is [kanji, kana]</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_candidateList</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>First term info in candidate list
used for transforming</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_firstKanji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_firstKana</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Previous selected term info
used to generate suggestions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_selectedKanji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_selectedKana</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Code of previous key pressed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_previousKeycode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Current keyboard</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_currLayout</span> <span class="o">=</span> <span class="s1">&#39;jp-kanji&#39;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">KeyMode</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;NORMAL&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s1">&#39;TRANSFORM&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s1">&#39;SELECT&#39;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s1">&#39;H2K&#39;</span><span class="o">:</span> <span class="mi">3</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">_keyboardMode</span> <span class="o">=</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_HIRAGANA</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p><em>* The following functions are compulsory functions in IME
and explicitly called in <code>keyboard.js</code> *</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_init</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>debug('init');</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_glue</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">uninit</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_uninit</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_dict</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_dict</span><span class="p">.</span><span class="nx">uninit</span><span class="p">();</span>
        <span class="nx">_dict</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">click</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_click</span><span class="p">(</span><span class="nx">keyCode</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>debug('click ' + keyCode);
push keyCode to working queue</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">qPush</span><span class="p">(</span><span class="nx">keyCode</span><span class="p">);</span>
      <span class="nx">qNext</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_select</span><span class="p">(</span><span class="nx">kanji</span><span class="p">,</span> <span class="nx">kana</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;select &#39;</span> <span class="o">+</span> <span class="nx">kanji</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">kana</span><span class="p">);</span>
      <span class="nx">_glue</span><span class="p">.</span><span class="nx">sendString</span><span class="p">(</span><span class="nx">kanji</span><span class="p">);</span>

      <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">kana</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="nx">_selectedKanji</span> <span class="o">=</span> <span class="nx">kanji</span><span class="p">;</span>
      <span class="nx">_selectedKana</span> <span class="o">=</span> <span class="nx">kana</span><span class="p">;</span>
      <span class="nx">_firstKana</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="nx">_firstKanji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>reset</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_previousKeycode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nx">qPush</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="nx">qNext</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">empty</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_empty</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;empty buffer.&#39;</span><span class="p">);</span>
      <span class="nx">_inputBuf</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">_selectedKanji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="nx">_selectedKana</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>
      <span class="nx">_keyboardMode</span> <span class="o">=</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_HIRAGANA</span><span class="p">;</span>
      <span class="nx">_previousKeycode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nx">sendPendingSymbols</span><span class="p">();</span>
      <span class="nx">_qIsWorking</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_dict</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">initDB</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_show</span><span class="p">(</span><span class="nx">inputType</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Show. Input type: &#39;</span> <span class="o">+</span> <span class="nx">inputType</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">layout</span> <span class="o">=</span> <span class="s1">&#39;jp-kanji&#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">inputType</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="nx">inputType</span> <span class="o">===</span> <span class="s1">&#39;text&#39;</span> <span class="o">||</span> <span class="nx">inputType</span> <span class="o">===</span> <span class="s1">&#39;textarea&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">layout</span> <span class="o">=</span> <span class="nx">_currLayout</span><span class="p">;</span>
      <span class="p">}</span>
  
      <span class="nx">_glue</span><span class="p">.</span><span class="nx">alterKeyboard</span><span class="p">(</span><span class="nx">layout</span><span class="p">);</span>      
    <span class="p">};</span>


    <span class="cm">/** BEGIN QUEUE **/</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>A <em>queue</em> contains all keys pressed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_keyQueue</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">_qIsWorking</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">qPush</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">queue_push</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_keyQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Start to pop key code from queue
All logic is in <code>handleSpecialKey</code> and <code>handleNormalKey</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">qNext</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">queue_next</span><span class="p">()</span> <span class="p">{</span>

      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;start queue working&#39;</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">_qIsWorking</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;queue is working. wait&#39;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">_qIsWorking</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_dict</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;DB has not initialized, defer processing.&#39;</span><span class="p">);</span>
        <span class="nx">initDB</span><span class="p">(</span><span class="nx">qNext</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_keyQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;queue is empty&#39;</span><span class="p">);</span>
        <span class="nx">_qIsWorking</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>pop key code from queue</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">_keyQueue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;queue pops key &#39;</span> <span class="o">+</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">code</span><span class="p">));</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">handleSpecialKey</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="o">||</span> <span class="nx">handleNormalKey</span><span class="p">(</span><span class="nx">code</span><span class="p">))</span> <span class="p">{</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>FIXME do we need this?
pass the key to IMEManager for default action
and run <code>qNext</code> again before exiting
_glue.sendKey(code);</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_qIsWorking</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">qNext</span><span class="p">();</span>
    <span class="p">};</span>
    <span class="cm">/** END QUEUE **/</span>

    <span class="kd">var</span> <span class="nx">handleNormalKey</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_handleNormalKey</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">kana</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;handleNormalKey &#39;</span> <span class="o">+</span> <span class="nx">kana</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>set keymode</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>push kana directly if previoius key is NEXT</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">_previousKeycode</span> <span class="o">===</span> <span class="nx">IMESpecialKey</span><span class="p">.</span><span class="nx">NEXT</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_previousKeycode</span> <span class="o">=</span> <span class="nx">code</span><span class="p">;</span>
        <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">kana</span><span class="p">);</span>
        <span class="nx">handleInputBuf</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>append new key code to the end of <code>_inputBuf</code>
and begin to deal with the new buf</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">prevKana</span> <span class="o">=</span> <span class="nx">_inputBuf</span><span class="p">[</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">nextKeyInfo</span> <span class="o">=</span> <span class="nx">getNextKeyInfo</span><span class="p">(</span><span class="nx">prevKana</span><span class="p">,</span> <span class="nx">kana</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">nextKeyInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">_inputBuf</span><span class="p">[</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">nextKeyInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">nextKeyInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="p">}</span>

      <span class="nx">handleInputBuf</span><span class="p">();</span>
      <span class="nx">_previousKeycode</span> <span class="o">=</span> <span class="nx">code</span><span class="p">;</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">handleSpecialKey</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_handleSpecialKey</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">immiReturn</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

      <span class="k">switch</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>This is a select function operation.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">handleInputBuf</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>cycle the IMEHiraganaCycleTable in reversal direction
Ex. 
  ['あ', 'い', 'う', 'え', 'お', 'ぁ', 'ぃ', 'ぅ', 'ぇ', 'ぉ']
  is the cycle table of あ
  あ will be displayed when user click BACK
  while い is the current char</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">case</span> <span class="nx">IMESpecialKey</span><span class="p">.</span><span class="nx">BACK</span><span class="o">:</span>
          <span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">getPreviousKeyInfo</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">[</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">_inputBuf</span><span class="p">[</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="nx">handleInputBuf</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>cursor postion previous</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">case</span> <span class="nx">IMESpecialKey</span><span class="p">.</span><span class="nx">PREVIOUS</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span> <span class="o">&amp;&amp;</span> <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">SELECT</span><span class="p">;</span>
            <span class="nx">handlePorN</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">SELECT</span> <span class="o">||</span> <span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">TRANSFORM</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_firstKana</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>
              <span class="nx">handleInputBuf</span><span class="p">();</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">handlePorN</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_firstKana</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">IMESpecialKey</span><span class="p">.</span><span class="nx">NEXT</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span> <span class="o">&amp;&amp;</span> <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">SELECT</span><span class="p">;</span>
            <span class="nx">handlePorN</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">SELECT</span> <span class="o">||</span> <span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">TRANSFORM</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_firstKana</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>
              <span class="nx">handleInputBuf</span><span class="p">();</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">handlePorN</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_firstKana</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Transform key</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">case</span> <span class="nx">IMESpecialKey</span><span class="p">.</span><span class="nx">TRANSFORM</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">TRANSFORM</span> <span class="o">&amp;&amp;</span> <span class="nx">_previousKeycode</span> <span class="o">!==</span> <span class="nx">IMESpecialKey</span><span class="p">.</span><span class="nx">TRANSFORM</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">TRANSFORM</span><span class="p">;</span>
          <span class="nx">handleTransform</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Hiragana, full-width katakana and half-width katakana convertor</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">case</span> <span class="nx">IMESpecialKey</span><span class="p">.</span><span class="nx">H2K</span><span class="o">:</span>

          <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">H2K</span><span class="p">;</span>

          <span class="nx">sendPendingSymbols</span><span class="p">();</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">_keyboardMode</span> <span class="o">===</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_HIRAGANA</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_keyboardMode</span> <span class="o">=</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_KATAKANA</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_keyboardMode</span> <span class="o">===</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_KATAKANA</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_keyboardMode</span> <span class="o">=</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">HALF_KATAKANA</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_keyboardMode</span> <span class="o">===</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">HALF_KATAKANA</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_keyboardMode</span> <span class="o">=</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_HIRAGANA</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">_keyboardMode</span> <span class="o">===</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_HIRAGANA</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">queryDict</span><span class="p">();</span>
          <span class="p">}</span>

          <span class="nx">updateCandidateList</span><span class="p">(</span><span class="nx">qNext</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">));</span>
          <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>大 &lt;-> 小
TODO num and alpha exception</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">case</span> <span class="nx">IMESpecialKey</span><span class="p">.</span><span class="nx">CASE_CHANGE</span><span class="o">:</span>
          <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">_inputBuf</span><span class="p">[</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
          <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">HiraganaCaseTable</span><span class="p">[</span><span class="nx">last</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span> <span class="o">=</span> <span class="nx">IMEFullKatakanaCaseTable</span><span class="p">[</span><span class="nx">last</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span> <span class="o">=</span> <span class="nx">IMEHalfKatakanaCaseTable</span><span class="p">[</span><span class="nx">last</span><span class="p">];</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">_inputBuf</span><span class="p">[</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
          <span class="nx">handleInputBuf</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
        </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Switch to basic layout</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">case</span> <span class="nx">IMESpecialKey</span><span class="p">.</span><span class="nx">BASIC_LAYOUT</span><span class="o">:</span>
          <span class="nx">alterKeyboard</span><span class="p">(</span><span class="s1">&#39;jp-kanji&#39;</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        </pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Switch to english layout</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">case</span> <span class="nx">IMESpecialKey</span><span class="p">.</span><span class="nx">EN_LAYOUT</span><span class="o">:</span>
          <span class="nx">alterKeyboard</span><span class="p">(</span><span class="s1">&#39;jp-kanji-en&#39;</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        </pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Switch to number layout</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">case</span> <span class="nx">IMESpecialKey</span><span class="p">.</span><span class="nx">NUM_LAYOUT</span><span class="o">:</span>
          <span class="nx">alterKeyboard</span><span class="p">(</span><span class="s1">&#39;jp-kanji-number&#39;</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Default key event</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">case</span> <span class="nx">KeyEvent</span><span class="p">.</span><span class="nx">DOM_VK_RETURN</span><span class="o">:</span>
          <span class="nx">handleReturn</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Default key event</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">case</span> <span class="nx">KeyEvent</span><span class="p">.</span><span class="nx">DOM_VK_BACK_SPACE</span><span class="o">:</span>
          <span class="nx">handleBackspace</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
      
        <span class="k">default</span><span class="o">:</span>
          <span class="nx">immiReturn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>


      <span class="k">if</span> <span class="p">(</span><span class="nx">immiReturn</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_previousKeycode</span> <span class="o">=</span> <span class="nx">code</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>
      <span class="nx">_keyboardMode</span> <span class="o">=</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_HIRAGANA</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Ignore key code less than 0
except those special code above</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;ignore meaningless key code &lt;= 0&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">alterKeyboard</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_alterKeyboard</span><span class="p">(</span><span class="nx">layout</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_currLayout</span> <span class="o">=</span> <span class="nx">layout</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
      <span class="nx">_glue</span><span class="p">.</span><span class="nx">alterKeyboard</span><span class="p">(</span><span class="nx">layout</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">handlePorN</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_handlePorN</span><span class="p">(</span><span class="nx">kanaArr</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;handlePorN &quot;</span> <span class="o">+</span> <span class="nx">kanaArr</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">__getTermsCallback1</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">handlePorN_getTermsCallback1</span><span class="p">(</span><span class="nx">terms</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">terms</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">_firstKana</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">kana</span><span class="p">;</span>
          <span class="nx">_firstKanji</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">kanji</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">_firstKana</span> <span class="o">=</span> <span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">kanaArr</span><span class="p">);</span>
          <span class="nx">_firstKanji</span> <span class="o">=</span> <span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">kanaArr</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">__getTermsCallback2</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">handlePorN_getTermsCallback2</span><span class="p">(</span><span class="nx">terms</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">candidates</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="nx">terms</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="nx">readTerm</span><span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">term</span><span class="p">.</span><span class="nx">kanji</span><span class="p">,</span> <span class="nx">term</span><span class="p">.</span><span class="nx">kana</span><span class="p">]);</span>
        <span class="p">});</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">candidates</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">_firstKanji</span><span class="p">,</span> <span class="nx">_firstKana</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="nx">_candidateList</span> <span class="o">=</span> <span class="nx">candidates</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>update _firstKana and _firstKanji</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_dict</span><span class="p">.</span><span class="nx">getTerms</span><span class="p">(</span><span class="nx">kanaArr</span><span class="p">,</span> <span class="nx">__getTermsCallback1</span><span class="p">);</span>

      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;firstTerm  &#39;</span> <span class="o">+</span> <span class="nx">_firstKanji</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">_firstKana</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Send pending symbols to highlight <code>_firstKanji</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">sendPendingSymbols</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>get candidates by _firstKana</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_dict</span><span class="p">.</span><span class="nx">getTerms</span><span class="p">(</span><span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayFromString</span><span class="p">(</span><span class="nx">_firstKana</span><span class="p">),</span> <span class="nx">__getTermsCallback2</span><span class="p">);</span>

      <span class="nx">updateCandidateList</span><span class="p">(</span><span class="nx">qNext</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">handleReturn</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_handleReturn</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">TRANSFORM</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_firstKana</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;handle return in transform mode&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>select first term</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">_glue</span><span class="p">.</span><span class="nx">sendString</span><span class="p">(</span><span class="nx">_firstKanji</span><span class="p">);</span>
        <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_firstKana</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;_inputBuf is &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>query to generate first term</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">queryDict</span><span class="p">();</span> </pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>do exactly like transforming</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">handleTransform</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">H2K</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_keyboardMode</span> <span class="o">===</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_HIRAGANA</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">mode</span> <span class="o">=</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">HALF_KATAKANA</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_keyboardMode</span> <span class="o">===</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_KATAKANA</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">mode</span> <span class="o">=</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_HIRAGANA</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_keyboardMode</span> <span class="o">===</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">HALF_KATAKANA</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">mode</span> <span class="o">=</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_KATAKANA</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">_glue</span><span class="p">.</span><span class="nx">sendString</span><span class="p">(</span><span class="nx">_getPossibleStrings</span><span class="p">(</span><span class="nx">mode</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">_inputBuf</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">_candidateList</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">_keyboardMode</span> <span class="o">=</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_HIRAGANA</span><span class="p">;</span>
        <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>
        <span class="nx">sendPendingSymbols</span><span class="p">();</span>
        <span class="nx">updateCandidateList</span><span class="p">(</span><span class="nx">qNext</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">));</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_firstKana</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;first term &#39;</span> <span class="o">+</span> <span class="nx">_firstKanji</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">_firstKana</span><span class="p">);</span>
          <span class="nx">_glue</span><span class="p">.</span><span class="nx">sendString</span><span class="p">(</span><span class="nx">_firstKanji</span><span class="p">);</span>
          <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_firstKana</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
          <span class="nx">handleInputBuf</span><span class="p">();</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">_glue</span><span class="p">.</span><span class="nx">sendKey</span><span class="p">(</span><span class="nx">KeyEvent</span><span class="p">.</span><span class="nx">DOM_VK_RETURN</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">handleBackspace</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_handleBackspace</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Backspace key&#39;</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_firstKana</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="nx">_firstKanji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="nx">_candidateList</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="nx">handleInputBuf</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>pass the key to IMEManager for default action</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_glue</span><span class="p">.</span><span class="nx">sendKey</span><span class="p">(</span><span class="nx">KeyEvent</span><span class="p">.</span><span class="nx">DOM_VK_BACK_SPACE</span><span class="p">);</span>

      <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
      <span class="nx">handleInputBuf</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">handleTransform</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_handleTransform</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;handleTransform&#39;</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;empty input buf, return&#39;</span><span class="p">);</span>
        <span class="nx">handleInputBuf</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Send pending symbols to highlight <code>_firstKanji</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">sendPendingSymbols</span><span class="p">();</span>

      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;firstTerm  &#39;</span> <span class="o">+</span> <span class="nx">_firstKanji</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">_firstKana</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>get candidates by _firstKana</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">__getTermsCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">handleTransform_getTermsCallback</span><span class="p">(</span><span class="nx">terms</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">candidates</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="nx">terms</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="nx">readTerm</span><span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">term</span><span class="p">.</span><span class="nx">kanji</span><span class="p">,</span> <span class="nx">term</span><span class="p">.</span><span class="nx">kana</span><span class="p">]);</span>
        <span class="p">});</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">candidates</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">_firstKanji</span><span class="p">,</span> <span class="nx">_firstKana</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">_firstKanji</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">kanji</span><span class="p">;</span>
          <span class="nx">_firstKana</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">kana</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">_candidateList</span> <span class="o">=</span> <span class="nx">candidates</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>only query <code>_firstKana</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_dict</span><span class="p">.</span><span class="nx">getTerms</span><span class="p">(</span><span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayFromString</span><span class="p">(</span><span class="nx">_firstKana</span><span class="p">),</span> <span class="nx">__getTermsCallback</span><span class="p">);</span>

      <span class="nx">updateCandidateList</span><span class="p">(</span><span class="nx">qNext</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">));</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>query, update pending symbols and candidate syllables
these three processes normally conbind as one</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">handleInputBuf</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_handleInputBuf</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">queryDict</span><span class="p">();</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Query dict, result will be used in sendPendingSymbols
 and updateCandidateList</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">queryDict</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_queryDict</span><span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">candidates</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_selectedKana</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Buffer is empty; &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;make suggestions based on select term.&#39;</span> <span class="o">+</span> <span class="nx">_selectedKanji</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">kana</span> <span class="o">=</span> <span class="nx">_selectedKana</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">kanji</span> <span class="o">=</span> <span class="nx">_selectedKanji</span><span class="p">;</span>
          <span class="nx">_selectedKana</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
          <span class="nx">_selectedKanji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
          <span class="nx">_candidateList</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>TODO </p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">_dict</span><span class="p">.</span><span class="nx">getSuggestions</span><span class="p">(</span><span class="nx">kana</span><span class="p">,</span> <span class="nx">kanji</span><span class="p">,</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">suggestions</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">suggestions</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span>
                <span class="kd">function</span> <span class="nx">suggestions_forEach</span><span class="p">(</span><span class="nx">suggestion</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
                    <span class="p">[</span><span class="nx">suggestion</span><span class="p">.</span><span class="nx">kanji</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">kanji</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span>
                     <span class="nx">kana</span><span class="p">]);</span>
                <span class="p">}</span>
              <span class="p">);</span>
              <span class="nx">_candidateList</span> <span class="o">=</span> <span class="nx">candidates</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">);</span>

          <span class="nx">sendPendingSymbols</span><span class="p">();</span>
          <span class="nx">updateCandidateList</span><span class="p">(</span><span class="nx">qNext</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">));</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Buffer is empty; send empty candidate list.&#39;</span><span class="p">);</span>
        <span class="nx">_firstKana</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="nx">_firstKanji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="nx">_candidateList</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">sendPendingSymbols</span><span class="p">();</span>
        <span class="nx">updateCandidateList</span><span class="p">(</span><span class="nx">qNext</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>reset</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_selectedKanji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="nx">_selectedKana</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Get term candidates for the entire buffer.&#39;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">__getTermsCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">queryDict_getTermsCallback</span><span class="p">(</span><span class="nx">terms</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;queryDict getTermsCallback&#39;</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">kanaStr</span> <span class="o">=</span> <span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">terms</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">_firstKanji</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">kanji</span><span class="p">;</span>
          <span class="nx">_firstKana</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">kana</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">_firstKanji</span> <span class="o">=</span> <span class="nx">kanaStr</span><span class="p">;</span>
          <span class="nx">_firstKana</span> <span class="o">=</span> <span class="nx">kanaStr</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">terms</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="nx">readTerm</span><span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">term</span><span class="p">.</span><span class="nx">kanji</span><span class="p">,</span> <span class="nx">term</span><span class="p">.</span><span class="nx">kana</span><span class="p">]);</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>only one kana in buf</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Only one kana; skip other lookups.&#39;</span><span class="p">);</span>

          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">candidates</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">kanaStr</span><span class="p">,</span> <span class="nx">kanaStr</span><span class="p">]);</span>
          <span class="p">}</span>

          <span class="nx">_candidateList</span> <span class="o">=</span> <span class="nx">candidates</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
          <span class="nx">sendPendingSymbols</span><span class="p">();</span>
          <span class="nx">updateCandidateList</span><span class="p">(</span><span class="nx">qNext</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">));</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">__getSentenceCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">getSentenceCallback</span><span class="p">(</span><span class="nx">sentence</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>sentence = [term, term]</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;getSentenceCallback:&#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">sentence</span><span class="p">));</span>

          <span class="nx">_firstKanji</span> <span class="o">=</span> <span class="nx">sentence</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">kanji</span><span class="p">;</span>
          <span class="nx">_firstKana</span> <span class="o">=</span> <span class="nx">sentence</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">kana</span><span class="p">;</span>

          <span class="kd">var</span> <span class="nx">sentenceKana</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">sentenceKanji</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

          <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>

          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">sentence</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sentenceKanji</span> <span class="o">+=</span> <span class="nx">sentence</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">kanji</span><span class="p">;</span>
            <span class="nx">sentenceKana</span> <span class="o">+=</span> <span class="nx">sentence</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">kana</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="kd">var</span> <span class="nx">kanaStr</span> <span class="o">=</span> <span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>look for candidate that is already in the list</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">exists</span> <span class="o">=</span> <span class="nx">candidates</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="kd">function</span> <span class="nx">sentenceExists</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="nx">candidate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">sentenceKanji</span><span class="p">);</span>
          <span class="p">});</span>

          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">sentenceKanji</span><span class="p">,</span> <span class="nx">sentenceKana</span><span class="p">]);</span>
          <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>The remaining candidates doesn't match the entire buffer
these candidates helps user find the exact character/term
s/he wants
The remaining unmatched kanas will go through lookup
over and over until the buffer is emptied.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">_dictMaxPredictLength</span><span class="p">,</span> <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">___findTerms</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">lookupFindTerms</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Lookup for terms that matches first &#39;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s1">&#39; kanas.&#39;</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">subBuf</span> <span class="o">=</span> <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>

            <span class="nx">_dict</span><span class="p">.</span><span class="nx">getTerms</span><span class="p">(</span><span class="nx">subBuf</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">lookupCallback</span><span class="p">(</span><span class="nx">terms</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">terms</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="nx">readTerm</span><span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">term</span><span class="p">.</span><span class="nx">kanji</span><span class="p">,</span> <span class="nx">term</span><span class="p">.</span><span class="nx">kana</span><span class="p">]);</span>
              <span class="p">});</span>

              <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">terms</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;The first kana does not make up a word,&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39; output the symbol.&#39;</span><span class="p">);</span>
                <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">kanaStr</span><span class="p">,</span> <span class="nx">kanaStr</span><span class="p">]);</span>
              <span class="p">}</span>

              <span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Done Looking.&#39;</span><span class="p">);</span>
                <span class="nx">_candidateList</span> <span class="o">=</span> <span class="nx">candidates</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
                <span class="nx">sendPendingSymbols</span><span class="p">();</span>
                <span class="nx">updateCandidateList</span><span class="p">(</span><span class="nx">qNext</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">));</span>
                <span class="k">return</span><span class="p">;</span>
              <span class="p">}</span>

              <span class="nx">___findTerms</span><span class="p">();</span>
              <span class="k">return</span><span class="p">;</span>
            <span class="p">});</span>
          <span class="p">};</span>

          <span class="nx">___findTerms</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Lookup for sentences that make up from the entire buffer&#39;</span><span class="p">);</span>

        <span class="nx">_dict</span><span class="p">.</span><span class="nx">getSentence</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">,</span> <span class="nx">__getSentenceCallback</span><span class="p">);</span>
      <span class="p">};</span>

      <span class="nx">_dict</span><span class="p">.</span><span class="nx">getTerms</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">,</span> <span class="nx">__getTermsCallback</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">_getPossibleStrings</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_getPossibleStrings</span><span class="p">(</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">table</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_HIRAGANA</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">table</span> <span class="o">=</span> <span class="nx">KeyboardFullKatakanaCycleTable</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">FULL_KATAKANA</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">table</span> <span class="o">=</span> <span class="nx">KeyboardHalfKatakanaCycleTable</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">IMEMode</span><span class="p">.</span><span class="nx">HALF_KATAKANA</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">table</span> <span class="o">=</span> <span class="nx">KeyboardHiraganaCycleTable</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">strFullKatakana</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">strHalfKatakana</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">strFullHiragana</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">displayStr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_inputBuf</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">getPosInfoByChar</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;get info &#39;</span> <span class="o">+</span> <span class="nx">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="nx">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>FIXME see bug list 1</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="nx">displayStr</span> <span class="o">+=</span> <span class="nx">table</span><span class="p">[</span><span class="nx">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="nx">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
        <span class="nx">debug</span><span class="p">(</span><span class="nx">displayStr</span><span class="p">);</span>
        
        <span class="nx">strFullHiragana</span> <span class="o">+=</span> <span class="nx">KeyboardHiraganaCycleTable</span><span class="p">[</span><span class="nx">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="nx">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
        <span class="nx">strFullKatakana</span> <span class="o">+=</span> <span class="nx">KeyboardFullKatakanaCycleTable</span><span class="p">[</span><span class="nx">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="nx">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
        <span class="nx">strHalfKatakana</span> <span class="o">+=</span> <span class="nx">KeyboardHalfKatakanaCycleTable</span><span class="p">[</span><span class="nx">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="nx">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="p">[</span><span class="nx">displayStr</span><span class="p">,</span> <span class="nx">strFullHiragana</span><span class="p">,</span> <span class="nx">strFullKatakana</span><span class="p">,</span> <span class="nx">strHalfKatakana</span><span class="p">];</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getDisplayStr</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_getDisplayStr</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">displayStr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">displayStr</span> <span class="o">=</span> <span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">TRANSFORM</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">_firstKanji</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">displayStr</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;background:#3333aa&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">_firstKanji</span> <span class="o">+</span> <span class="s2">&quot;&lt;/span&gt;&quot;</span><span class="p">;</span>
          <span class="nx">displayStr</span> <span class="o">+=</span> <span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">).</span><span class="nx">substr</span><span class="p">(</span><span class="nx">_firstKana</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="p">}</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">SELECT</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">_firstKanji</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">_keyMode</span> <span class="o">=</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">displayStr</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;background:#33aa33&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">_firstKanji</span> <span class="o">+</span> <span class="s2">&quot;&lt;/span&gt;&quot;</span><span class="p">;</span>
          <span class="nx">displayStr</span> <span class="o">+=</span> <span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">).</span><span class="nx">substr</span><span class="p">(</span><span class="nx">_firstKana</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="p">}</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_keyMode</span> <span class="o">===</span> <span class="nx">KeyMode</span><span class="p">.</span><span class="nx">H2K</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">strs</span> <span class="o">=</span> <span class="nx">_getPossibleStrings</span><span class="p">(</span><span class="nx">_keyboardMode</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">candidates</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">displayStr</span> <span class="o">=</span> <span class="nx">strs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>candidate list is updated here 
to avoide loop again in <code>handleInputBuf</code>
TODO reorder these three candidates</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">),</span> <span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">)]);</span>
        <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">strs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">)]);</span>
        <span class="nx">candidates</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">strs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">_inputBuf</span><span class="p">)]);</span>

        <span class="nx">_candidateList</span> <span class="o">=</span> <span class="nx">candidates</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">displayStr</span><span class="p">;</span>

    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Send pending symbols to display</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">sendPendingSymbols</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_sendPendingSymbols</span><span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">displayStr</span> <span class="o">=</span> <span class="nx">getDisplayStr</span><span class="p">();</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;sending pending symbols: &#39;</span> <span class="o">+</span> <span class="nx">displayStr</span><span class="p">);</span>

      <span class="nx">_glue</span><span class="p">.</span><span class="nx">sendPendingSymbols</span><span class="p">(</span><span class="nx">displayStr</span><span class="p">);</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Update candidate list</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">updateCandidateList</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_updateCandidateList</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;update candidate list&#39;</span><span class="p">);</span>

      <span class="nx">sendCandidates</span><span class="p">(</span><span class="nx">_candidateList</span><span class="p">);</span>
      <span class="nx">_glue</span><span class="p">.</span><span class="nx">sendCandidates</span><span class="p">(</span><span class="nx">candidates</span><span class="p">);</span>
      <span class="nx">callback</span><span class="p">();</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Get json and init indexedDB if possible</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">initDB</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ime_initDB</span><span class="p">(</span><span class="nx">readyCallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">dbSettings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">enableIndexedDB</span><span class="o">:</span> <span class="nx">_enableIndexedDB</span>
      <span class="p">};</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">readyCallback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dbSettings</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="nx">readyCallback</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">jsonUrl</span> <span class="o">=</span> <span class="nx">_glue</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span> <span class="s1">&#39;/dict.json&#39;</span><span class="p">;</span>
      <span class="nx">_dict</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IMEngineDatabase</span><span class="p">(</span><span class="s1">&#39;jskanji&#39;</span><span class="p">,</span> <span class="nx">jsonUrl</span><span class="p">);</span>
      <span class="nx">_dict</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">dbSettings</span><span class="p">);</span>
    <span class="p">};</span>

  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">jskanji</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IMEngine</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Expose as an AMD module</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;jskanji&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">jskanji</span><span class="p">;</span> <span class="p">});</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Expose to IMEManager if we are in Gaia homescreen</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">IMEManager</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">IMEManager</span><span class="p">.</span><span class="nx">IMEngines</span><span class="p">.</span><span class="nx">jskanji</span> <span class="o">=</span> <span class="nx">jskanji</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* copy from jszhuyin */</span>
  <span class="kd">var</span> <span class="nx">debugging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">debugging</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">dump</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="s1">&#39;JP: &#39;</span> <span class="o">+</span> <span class="nx">str</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">console</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;JP: &#39;</span> <span class="o">+</span> <span class="nx">str</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>for non-Mozilla browsers</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">KeyEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">KeyEvent</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">DOM_VK_BACK_SPACE</span><span class="o">:</span> <span class="mh">0x8</span><span class="p">,</span>
      <span class="nx">DOM_VK_RETURN</span><span class="o">:</span> <span class="mh">0xd</span>
    <span class="p">};</span>
  <span class="p">}</span>
  <span class="cm">/* end copy */</span>

  <span class="kd">var</span> <span class="nx">SyllableUtils</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/**</span>
<span class="cm">     * Converts a syllables array to a string.</span>
<span class="cm">     * For example, [&#39;わ&#39;, &#39;た&#39;, &#39;し&#39;] will be converted to &#39;わたし&#39;.</span>
<span class="cm">     */</span>
    <span class="nx">arrayToString</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">syllableUtils_arrayToString</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Converts a syllables string to an array.</span>
<span class="cm">     * For example, &#39;わたし&#39; will be converted to [&#39;わ&#39;, &#39;た&#39;, &#39;し&#39;].</span>
<span class="cm">     */</span>
    <span class="nx">arrayFromString</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">syllableUtils_arrayFromString</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">Term</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">term_constructor</span><span class="p">(</span><span class="nx">kana</span><span class="p">,</span> <span class="nx">freq</span><span class="p">,</span> <span class="nx">kanji</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">kana</span> <span class="o">=</span> <span class="nx">kana</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">freq</span> <span class="o">=</span> <span class="nx">freq</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">kanji</span> <span class="o">=</span> <span class="nx">kanji</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Term</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/*The actual string of the term */</span>
    <span class="nx">kana</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="cm">/* The frequency of the term*/</span>
    <span class="nx">freq</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">kanji</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
  <span class="p">};</span>

  <span class="cm">/**</span>
<span class="cm">   * Terms with same kana</span>
<span class="cm">   */</span>
  <span class="kd">var</span> <span class="nx">Homonyms</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">homonyms_constructor</span><span class="p">(</span><span class="nx">kana</span><span class="p">,</span> <span class="nx">terms</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">kana</span> <span class="o">=</span> <span class="nx">kana</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Clone a new array</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">terms</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">.</span><span class="nx">concat</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">Homonyms</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">kana</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Terms array</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">terms</span><span class="o">:</span> <span class="kc">null</span>
  <span class="p">};</span>

  <span class="cm">/**</span>
<span class="cm">   * An index class to speed up the search operation for ojbect array.</span>
<span class="cm">   * @param {Array} targetArray The array to be indexed.</span>
<span class="cm">   * @param {String} keyPath The key path for the index to use.</span>
<span class="cm">   */</span>
  <span class="kd">var</span> <span class="nx">Index</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">index_constructor</span><span class="p">(</span><span class="nx">targetArray</span><span class="p">,</span> <span class="nx">keyPath</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_keyMap</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">targetArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">targetArray</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">keyPath</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_keyMap</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_keyMap</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_keyMap</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">Index</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Map the key to the index of the storage array</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_keyMap</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Keys array in ascending order.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_sortedKeys</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

    <span class="cm">/**</span>
<span class="cm">     * Get array indices by given key.</span>
<span class="cm">     * @return {Array} An array of index.</span>
<span class="cm">     */</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">index_get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">indices</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_keyMap</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">indices</span> <span class="o">=</span> <span class="nx">indices</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_keyMap</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">indices</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Get array indices by given key range.</span>
<span class="cm">     * @param {String} lower The lower bound of the key range. If null, the range</span>
<span class="cm">     * has no lower bound.</span>
<span class="cm">     * @param {String} upper The upper bound of the key range. If null, the range</span>
<span class="cm">     * has no upper bound.</span>
<span class="cm">     * @param {Boolean} lowerOpen If false, the range includes the lower bound</span>
<span class="cm">     * value. If the range has no lower bound, it will be ignored.</span>
<span class="cm">     * @param {Boolean} upperOpen If false, the range includes the upper bound</span>
<span class="cm">     * value. If the range has no upper bound, it will be ignored.</span>
<span class="cm">     * @return {Array} An array of index.</span>
<span class="cm">     */</span>
    <span class="nx">getRange</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">index_getRange</span><span class="p">(</span><span class="nx">lower</span><span class="p">,</span> <span class="nx">upper</span><span class="p">,</span> <span class="nx">lowerOpen</span><span class="p">,</span> <span class="nx">upperOpen</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">indices</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">indices</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>lower bound position</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">lowerPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>uppder bound position</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">upperPos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">lower</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_binarySearch</span><span class="p">(</span><span class="nx">lower</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">upperPos</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">==</span> <span class="kc">Infinity</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">indices</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">!=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">lowerPos</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">lowerOpen</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span><span class="p">[</span><span class="nx">lowerPos</span><span class="p">]</span> <span class="o">==</span> <span class="nx">lower</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">lowerPos</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">upper</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_binarySearch</span><span class="p">(</span><span class="nx">upper</span><span class="p">,</span> <span class="nx">lowerPos</span><span class="p">,</span> <span class="nx">upperPos</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">==</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">indices</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">!=</span> <span class="kc">Infinity</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">upperPos</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">upperOpen</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span><span class="p">[</span><span class="nx">upperPos</span><span class="p">]</span> <span class="o">==</span> <span class="nx">upper</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">upperPos</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">lowerPos</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">upperPos</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">indices</span> <span class="o">=</span> <span class="nx">indices</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_keyMap</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">indices</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Search the key position.</span>
<span class="cm">     * @param {String} key The key to search.</span>
<span class="cm">     * @param {Number} left The begin position of the array. It should be less</span>
<span class="cm">     * than the right parameter.</span>
<span class="cm">     * @param {Number} right The end position of the array.It should be greater</span>
<span class="cm">     * than the left parameter.</span>
<span class="cm">     * @return {Number} If success, returns the index of the key.</span>
<span class="cm">     * If the key is between two adjacent keys, returns the average index of the</span>
<span class="cm">     * two keys. If the key is out of bounds, returns Infinity or -Infinity.</span>
<span class="cm">     */</span>
    <span class="nx">_binarySearch</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">index_binarySearch</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span><span class="p">[</span><span class="nx">left</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span><span class="p">[</span><span class="nx">right</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">Infinity</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">while</span> <span class="p">(</span><span class="nx">right</span> <span class="o">&gt;</span> <span class="nx">left</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mid</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">midKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span><span class="p">[</span><span class="nx">mid</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">midKey</span> <span class="o">&lt;</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">left</span> <span class="o">=</span> <span class="nx">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">midKey</span> <span class="o">&gt;</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">right</span> <span class="o">=</span> <span class="nx">mid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">mid</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>left == right == mid</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">leftKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortedKeys</span><span class="p">[</span><span class="nx">left</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">leftKey</span> <span class="o">==</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">left</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">leftKey</span> <span class="o">&lt;</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">left</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">left</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">Task</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">task_constructor</span><span class="p">(</span><span class="nx">taskFunc</span><span class="p">,</span> <span class="nx">taskData</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">func</span> <span class="o">=</span> <span class="nx">taskFunc</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">taskData</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Task</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/**</span>
<span class="cm">     * Task function</span>
<span class="cm">     */</span>
    <span class="nx">func</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="cm">/**</span>
<span class="cm">     * Task private data</span>
<span class="cm">     */</span>
    <span class="nx">data</span><span class="o">:</span> <span class="kc">null</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">TaskQueue</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">taskQueue_constructor</span><span class="p">(</span><span class="nx">oncomplete</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oncomplete</span> <span class="o">=</span> <span class="nx">oncomplete</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">};</span>

  <span class="nx">TaskQueue</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/**</span>
<span class="cm">     * Callback Javascript function object that is called when the task queue is</span>
<span class="cm">     * empty. The definition of callback is function oncomplete(queueData).</span>
<span class="cm">     */</span>
    <span class="nx">oncomplete</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

    <span class="cm">/**</span>
<span class="cm">     * Data sharing with all tasks of the queue</span>
<span class="cm">     */</span>
    <span class="nx">data</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

    <span class="cm">/**</span>
<span class="cm">     * Task queue array.</span>
<span class="cm">     */</span>
    <span class="nx">_queue</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

    <span class="cm">/**</span>
<span class="cm">     * Add a new task to the tail of the queue.</span>
<span class="cm">     * @param {Function} taskFunc Task function object. The definition is function</span>
<span class="cm">     * taskFunc(taskQueue, taskData).</span>
<span class="cm">     * The taskQueue parameter is the task queue object itself, while the taskData</span>
<span class="cm">     * parameter is the data property</span>
<span class="cm">     * of the task queue object.</span>
<span class="cm">     * @param {Object} taskData The task&#39;s private data.</span>
<span class="cm">     */</span>
    <span class="nx">push</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">taskQueue_push</span><span class="p">(</span><span class="nx">taskFunc</span><span class="p">,</span> <span class="nx">taskData</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Task</span><span class="p">(</span><span class="nx">taskFunc</span><span class="p">,</span> <span class="nx">taskData</span><span class="p">));</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Start running the task queue or process the next task.</span>
<span class="cm">     * It should be called when a task, including the last one, is finished.</span>
<span class="cm">     */</span>
    <span class="nx">processNext</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">taskQueue_processNext</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">task</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">task</span><span class="p">.</span><span class="nx">func</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">task</span><span class="p">.</span><span class="nx">func</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">task</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">processNext</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">oncomplete</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">oncomplete</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Get the number of remaining tasks.</span>
<span class="cm">     */</span>
    <span class="nx">getSize</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">taskQueue_getSize</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">DatabaseStorageBase</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">storagebase_constructor</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">};</span>

  <span class="cm">/**</span>
<span class="cm">   * DatabaseStorageBase status code enumeration.</span>
<span class="cm">   */</span>
  <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/* The storage isn&#39;t initilized.*/</span>
    <span class="nx">UNINITIALIZED</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="cm">/* The storage is busy.*/</span>
    <span class="nx">BUSY</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="cm">/* The storage has been successfully initilized and is ready to use.*/</span>
    <span class="nx">READY</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="cm">/* The storage is failed to initilized and cannot be used.*/</span>
    <span class="nx">ERROR</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">};</span>

  <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">_status</span><span class="o">:</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="p">,</span>

    <span class="cm">/**</span>
<span class="cm">     * Get the status code of the storage.</span>
<span class="cm">     * @return {DatabaseStorageBase.StatusCode} The status code.</span>
<span class="cm">     */</span>
    <span class="nx">getStatus</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">storagebase_getStatus</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_status</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Whether the database is ready to use.</span>
<span class="cm">     */</span>
    <span class="nx">isReady</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">storagebase_isReady</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_status</span> <span class="o">==</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">READY</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Initialization.</span>
<span class="cm">     * @param {Function} callback Javascript function object that is called when</span>
<span class="cm">     * the operation is finished. The definition of callback is</span>
<span class="cm">     * function callback(statusCode). The statusCode parameter is of type</span>
<span class="cm">     * DatabaseStorageBase.StatusCode that stores the status of the storage</span>
<span class="cm">     * after Initialization.</span>
<span class="cm">     */</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">storagebase_init</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Destruction.</span>
<span class="cm">     * @param {Function} callback Javascript function object that is called when</span>
<span class="cm">     * the operation is finished.</span>
<span class="cm">     * The definition of callback is function callback().</span>
<span class="cm">     */</span>
    <span class="nx">uninit</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">storagebase_uninit</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">},</span>


    <span class="cm">/**</span>
<span class="cm">     * Whether the storage is empty.</span>
<span class="cm">     * @return {Boolean} true if the storage is empty; otherwise false.</span>
<span class="cm">     */</span>
    <span class="nx">isEmpty</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">storagebase_isEmpty</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Get all terms.</span>
<span class="cm">     * @param {Function} callback Javascript function object that is called when</span>
<span class="cm">     * the operation is finished. The definition of callback is</span>
<span class="cm">     * function callback(homonymsArray). The homonymsArray parameter is an array</span>
<span class="cm">     * of Homonyms objects.</span>
<span class="cm">     */</span>
    <span class="nx">getAllTerms</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">storagebase_getAllTerms</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Set all the terms of the storage.</span>
<span class="cm">     * @param {Array} homonymsArray The array of Homonyms objects containing all</span>
<span class="cm">     * the terms.</span>
<span class="cm">     * @param {Function} callback Javascript function object that is called when</span>
<span class="cm">     * the operation is finished. The definition of callback is</span>
<span class="cm">     * function callback().</span>
<span class="cm">     */</span>
    <span class="nx">setAllTerms</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">storagebase_setAllTerms</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Get iterm with given syllables string.</span>
<span class="cm">     * @param {String} syllablesStr The syllables string of the matched terms.</span>
<span class="cm">     * @param {Function} callback Javascript function object that is called when</span>
<span class="cm">     * the operation is finished. The definition of callback is</span>
<span class="cm">     * function callback(homonymsArray). The homonymsArray parameter is an array</span>
<span class="cm">     * of Homonyms objects.</span>
<span class="cm">     */</span>
    <span class="nx">getTermsByKana</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">storagebase_getTermsByKana</span><span class="p">(</span>
                             <span class="nx">syllablesStr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Get iterms with given syllables string prefix.</span>
<span class="cm">     * @param {String} prefix The prefix of the syllables string .</span>
<span class="cm">     * @param {Function} callback Javascript function object that is called when</span>
<span class="cm">     * the operation is finished. The definition of callback is</span>
<span class="cm">     * function callback(homonymsArray). The homonymsArray parameter is an array</span>
<span class="cm">     * of Homonyms objects.</span>
<span class="cm">     */</span>
    <span class="nx">getTermsByKanaPrefix</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">storagebase_getTermsByKanaPrefix</span><span class="p">(</span>
                              <span class="nx">prefix</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Add a term to the storage.</span>
<span class="cm">     * @param {String} syllablesStr The syllables string of the term.</span>
<span class="cm">     * @param {Term} term The Term object of the term.</span>
<span class="cm">     * @param {Function} callback Javascript function object that is called when</span>
<span class="cm">     * the operation is finished. The definition of callback is</span>
<span class="cm">     * function callback().</span>
<span class="cm">     */</span>
    <span class="nx">addTerm</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">storagebase_addTerm</span><span class="p">(</span><span class="nx">syllablesStr</span><span class="p">,</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Remove a term from the storage.</span>
<span class="cm">     * @param {String} syllablesStr The syllables string of the term.</span>
<span class="cm">     * @param {Term} term The Term object of the term.</span>
<span class="cm">     * @param {Function} callback Javascript function object that is called when</span>
<span class="cm">     * the operation is finished. The definition of callback is</span>
<span class="cm">     * function callback().</span>
<span class="cm">     */</span>
    <span class="nx">removeTerm</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">storagebase_removeTerm</span><span class="p">(</span><span class="nx">syllablesStr</span><span class="p">,</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">JsonStorage</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">jsonStorage_construtor</span><span class="p">(</span><span class="nx">jsonUrl</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_jsonUrl</span> <span class="o">=</span> <span class="nx">jsonUrl</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_dataArray</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">};</span>

  <span class="nx">JsonStorage</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Inherits DatabaseStorageBase</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">__proto__</span><span class="o">:</span> <span class="k">new</span> <span class="nx">DatabaseStorageBase</span><span class="p">(),</span>

    <span class="nx">_dataArray</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>The JSON file url.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_jsonUrl</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

    <span class="nx">_kanaIndex</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

    <span class="nx">_abrreviatedIndex</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">jsonStorage_init</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">doCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">init_doCallback</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_status</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Check if we could initilize.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_status</span> <span class="o">!=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">doCallback</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Set the status to busy.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">BUSY</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_jsonUrl</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">overrideMimeType</span><span class="p">(</span><span class="s1">&#39;application/json; charset=utf-8&#39;</span><span class="p">);</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">xhrReadystatechange</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">ERROR</span><span class="p">;</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">response</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">try</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>clone everything under response because it's readonly.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">self</span><span class="p">.</span><span class="nx">_dataArray</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
          <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_dataArray</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">ERROR</span><span class="p">;</span>
          <span class="nx">doCallback</span><span class="p">();</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">xhr</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">performBuildIndices</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
      <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">performBuildIndices</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">init_performBuildIndices</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_buildIndices</span><span class="p">();</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">READY</span><span class="p">;</span>
        <span class="nx">doCallback</span><span class="p">();</span>
      <span class="p">};</span>

      <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">uninit</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">jsonStorage_uninit</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">doCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">uninit_doCallback</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Check if we could uninitilize the storage</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_status</span> <span class="o">==</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">doCallback</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Perform destruction operation</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">_dataArray</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="p">;</span>
      <span class="nx">doCallback</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">isEmpty</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">jsonStorage_isEmpty</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_dataArray</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">getAllTerms</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">jsonStorage_getAllTerms</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">homonymsArray</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">doCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">getAllTerms_doCallback</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Check if the storage is ready.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isReady</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">doCallback</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">perform</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">getAllTerms_perform</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Query all terms</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">homonymsArray</span> <span class="o">=</span> <span class="nx">homonymsArray</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_dataArray</span><span class="p">);</span>
        <span class="nx">doCallback</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">perform</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getTermsByKana</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">jsonStorage_getTermsByKana</span><span class="p">(</span><span class="nx">kanaStr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">homonymsArray</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">doCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">getTermsByKana_doCallback</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Check if the storage is ready.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isReady</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">doCallback</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">perform</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">getTermsByKana_perform</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">indices</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_kanaIndex</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">kanaStr</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">indices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">homonymsArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_dataArray</span><span class="p">[</span><span class="nx">index</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="nx">doCallback</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">perform</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">},</span>

   <span class="nx">getTermsByKanaPrefix</span><span class="o">:</span> <span class="kd">function</span>
     <span class="nx">jsonStorage_getTermsByKanaPrefix</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
       <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
       <span class="kd">var</span> <span class="nx">homonymsArray</span> <span class="o">=</span> <span class="p">[];</span>
       <span class="kd">function</span> <span class="nx">doCallback</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">callback</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">);</span>
         <span class="p">}</span>
       <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Check if the storage is ready.</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isReady</span><span class="p">())</span> <span class="p">{</span>
         <span class="nx">doCallback</span><span class="p">();</span>
         <span class="k">return</span><span class="p">;</span>
       <span class="p">}</span>

       <span class="kd">var</span> <span class="nx">perform</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">upperBound</span> <span class="o">=</span> <span class="nx">prefix</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
           <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">prefix</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">prefix</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
         <span class="kd">var</span> <span class="nx">indices</span> <span class="o">=</span>
           <span class="nx">self</span><span class="p">.</span><span class="nx">_kanaIndex</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">upperBound</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">indices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
           <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
           <span class="nx">homonymsArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_dataArray</span><span class="p">[</span><span class="nx">index</span><span class="p">]);</span>
         <span class="p">}</span>
         <span class="nx">doCallback</span><span class="p">();</span>
       <span class="p">}</span>

       <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">perform</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
     <span class="p">},</span>

   <span class="nx">_buildIndices</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">jsonStorage_buildIndices</span><span class="p">()</span> <span class="p">{</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">_kanaIndex</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Index</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dataArray</span><span class="p">,</span> <span class="s1">&#39;kana&#39;</span><span class="p">);</span>
   <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p><strong>Interfaces of indexedDB</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">IndexedDB</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">indexedDB</span><span class="o">:</span> <span class="nb">window</span><span class="p">.</span><span class="nx">indexedDB</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitIndexedDB</span> <span class="o">||</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">mozIndexedDB</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">msIndexedDB</span><span class="p">,</span>

    <span class="nx">IDBDatabase</span><span class="o">:</span> <span class="nb">window</span><span class="p">.</span><span class="nx">IDBDatabase</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitIDBDatabase</span> <span class="o">||</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">msIDBDatabase</span><span class="p">,</span>

    <span class="nx">IDBIndex</span><span class="o">:</span> <span class="nb">window</span><span class="p">.</span><span class="nx">IDBIndex</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitIDBIndex</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">msIDBIndex</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Check if the indexedDB is available on this platform</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">isReady</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">indexedDB_isReady</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">indexedDB</span> <span class="o">||</span> <span class="c1">// No IndexedDB API implementation</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">IDBDatabase</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setVersion</span> <span class="o">||</span> <span class="c1">// old version of IndexedDB API</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;file:&#39;</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// bug 643318</span>

        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;IndexedDB is not available on this platform.&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>
  <span class="cm">/* end IndexedDB */</span>

  <span class="kd">var</span> <span class="nx">IndexedDBStorage</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">indexedDBStorage_constructor</span><span class="p">(</span><span class="nx">dbName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_dbName</span> <span class="o">=</span> <span class="nx">dbName</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">IndexedDBStorage</span><span class="p">.</span><span class="nx">kDBVersion</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

  <span class="nx">IndexedDBStorage</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Inherits DatabaseStorageBase</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">__proto__</span><span class="o">:</span> <span class="k">new</span> <span class="nx">DatabaseStorageBase</span><span class="p">(),</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Database name</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_dbName</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>IDBDatabase interface</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_IDBDatabase</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

    <span class="nx">_count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">indexedDBStorage_init</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">function</span> <span class="nx">doCallback</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_status</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Check if we could initilize.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">IndexedDB</span><span class="p">.</span><span class="nx">isReady</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_status</span> <span class="o">!=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">doCallback</span><span class="p">();</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Set the status to busy.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">BUSY</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Open the database</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">IndexedDB</span><span class="p">.</span><span class="nx">indexedDB</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dbName</span><span class="p">,</span>
          <span class="nx">IndexedDBStorage</span><span class="p">.</span><span class="nx">kDBVersion</span><span class="p">);</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">dbopenError</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Encounter error while opening IndexedDB.&#39;</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">ERROR</span><span class="p">;</span>
        <span class="nx">doCallback</span><span class="p">();</span>
      <span class="p">};</span>

      <span class="nx">req</span><span class="p">.</span><span class="nx">onupgradeneeded</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">dbopenUpgradeneeded</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;IndexedDB upgradeneeded.&#39;</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_IDBDatabase</span> <span class="o">=</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>delete the old ObjectStore if present</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_IDBDatabase</span><span class="p">.</span><span class="nx">objectStoreNames</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">_IDBDatabase</span><span class="p">.</span><span class="nx">deleteObjectStore</span><span class="p">(</span><span class="s1">&#39;homonyms&#39;</span><span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>create ObjectStore</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_IDBDatabase</span><span class="p">.</span><span class="nx">createObjectStore</span><span class="p">(</span><span class="s1">&#39;homonyms&#39;</span><span class="p">,</span>
            <span class="p">{</span> <span class="nx">keyPath</span><span class="o">:</span> <span class="s1">&#39;kana&#39;</span> <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>no callback() here
onupgradeneeded will follow by onsuccess event</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">};</span>

      <span class="nx">req</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">dbopenSuccess</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;IndexedDB opened.&#39;</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_IDBDatabase</span> <span class="o">=</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">READY</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Check the integrity of the storage</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">self</span><span class="p">.</span><span class="nx">getTermsByKana</span><span class="p">(</span><span class="s1">&#39;_last_entry_&#39;</span><span class="p">,</span>
          <span class="kd">function</span> <span class="nx">getLastEntryCallback</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">homonymsArray</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;IndexedDB is broken.&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Could not find the '<em>last</em>entry_' element. The storage is broken
and ignore all the data.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nx">doCallback</span><span class="p">();</span>
              <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">var</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_IDBDatabase</span><span class="p">.</span><span class="nx">transaction</span><span class="p">([</span><span class="s1">&#39;homonyms&#39;</span><span class="p">],</span> <span class="s1">&#39;readonly&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Get the count</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">reqCount</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;homonyms&#39;</span><span class="p">).</span><span class="nx">count</span><span class="p">();</span>

            <span class="nx">reqCount</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;IndexedDB count: &#39;</span> <span class="o">+</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">_count</span> <span class="o">=</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">READY</span><span class="p">;</span>
              <span class="nx">doCallback</span><span class="p">();</span>
            <span class="p">};</span>

            <span class="nx">reqCount</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">ERROR</span><span class="p">;</span>
              <span class="nx">doCallback</span><span class="p">();</span>
            <span class="p">};</span>
          <span class="p">});</span>
      <span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">uninit</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">indexedDBStorage_uninit</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">function</span> <span class="nx">doCallback</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Check if we could uninitilize the storage</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_status</span> <span class="o">==</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">doCallback</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Perform destruction operation</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_IDBDatabase</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_IDBDatabase</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="p">;</span>
      <span class="nx">doCallback</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">isEmpty</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">indexedDBStorage_isEmpty</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">getAllTerms</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">indexedDBStorage_getAllTerms</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">homonymsArray</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">function</span> <span class="nx">doCallback</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Check if the storage is ready.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isReady</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">doCallback</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Query all terms</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">store</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_IDBDatabase</span><span class="p">.</span><span class="nx">transaction</span><span class="p">([</span><span class="s1">&#39;homonyms&#39;</span><span class="p">],</span> <span class="s1">&#39;readonly&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;homonyms&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">openCursor</span><span class="p">();</span>

      <span class="nx">req</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Database read error.&#39;</span><span class="p">);</span>
        <span class="nx">doCallback</span><span class="p">();</span>
      <span class="p">};</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">homonyms</span> <span class="o">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">homonyms</span><span class="p">.</span><span class="nx">kana</span> <span class="o">!=</span> <span class="s1">&#39;_last_entry_&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">homonymsArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">homonyms</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">cursor</span><span class="p">.</span><span class="k">continue</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">doCallback</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">setAllTerms</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">indexedDBStorage_setAllTerms</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">function</span> <span class="nx">doCallback</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">READY</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">homonymsArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Check if the storage is ready.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isReady</span><span class="p">()</span> <span class="o">||</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">doCallback</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>Set the status to busy.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">BUSY</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Use task queue to add the terms by batch to prevent blocking the main
thread.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">taskQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TaskQueue</span><span class="p">(</span>
          <span class="kd">function</span> <span class="nx">taskQueueOnCompleteCallback</span><span class="p">(</span><span class="nx">queueData</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">_count</span> <span class="o">=</span> <span class="nx">n</span><span class="p">;</span>
            <span class="nx">doCallback</span><span class="p">();</span>
          <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">processNextWithDelay</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">setAllTerms_rocessNextWithDelay</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="nx">nextTask</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">taskQueue</span><span class="p">.</span><span class="nx">processNext</span><span class="p">();</span>
        <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Clear all the terms before adding</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">clearAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">setAllTerms_clearAll</span><span class="p">(</span><span class="nx">taskQueue</span><span class="p">,</span> <span class="nx">taskData</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">transaction</span> <span class="o">=</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">_IDBDatabase</span><span class="p">.</span><span class="nx">transaction</span><span class="p">([</span><span class="s1">&#39;homonyms&#39;</span><span class="p">],</span> <span class="s1">&#39;readwrite&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;homonyms&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;IndexedDB cleared.&#39;</span><span class="p">);</span>
          <span class="nx">processNextWithDelay</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="nx">req</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Failed to clear IndexedDB.&#39;</span><span class="p">);</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">_status</span> <span class="o">=</span> <span class="nx">DatabaseStorageBase</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">.</span><span class="nx">ERROR</span><span class="p">;</span>
          <span class="nx">doCallback</span><span class="p">();</span>
        <span class="p">};</span>

      <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Add a batch of terms</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">addChunk</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">setAllTerms_addChunk</span><span class="p">(</span><span class="nx">taskQueue</span><span class="p">,</span> <span class="nx">taskData</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">transaction</span> <span class="o">=</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">_IDBDatabase</span><span class="p">.</span><span class="nx">transaction</span><span class="p">([</span><span class="s1">&#39;homonyms&#39;</span><span class="p">],</span> <span class="s1">&#39;readwrite&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;homonyms&#39;</span><span class="p">);</span>
        <span class="nx">transaction</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Database write error.&#39;</span><span class="p">);</span>
          <span class="nx">doCallback</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="nx">transaction</span><span class="p">.</span><span class="nx">oncomplete</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">processNextWithDelay</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="kd">var</span> <span class="nx">begin</span> <span class="o">=</span> <span class="nx">taskData</span><span class="p">.</span><span class="nx">begin</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">taskData</span><span class="p">.</span><span class="nx">end</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">begin</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">end</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">homonyms</span> <span class="o">=</span> <span class="nx">homonymsArray</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">store</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">homonyms</span><span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Add a special element to indicate that all the items are saved.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">===</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;=======================&#39;</span><span class="p">);</span>
          <span class="nx">store</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="k">new</span> <span class="nx">Homonyms</span><span class="p">(</span><span class="s1">&#39;_last_entry_&#39;</span><span class="p">,</span> <span class="p">[]));</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>throw('jdkdkdjd');</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">}</span>
      <span class="p">};</span>

      <span class="nx">taskQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">clearAll</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">begin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">begin</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">begin</span> <span class="o">+=</span> <span class="mi">2000</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">begin</span> <span class="o">+</span> <span class="mi">1999</span><span class="p">,</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">taskQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">addChunk</span><span class="p">,</span> <span class="p">{</span><span class="nx">begin</span><span class="o">:</span> <span class="nx">begin</span><span class="p">,</span> <span class="nx">end</span><span class="o">:</span> <span class="nx">end</span><span class="p">});</span>
      <span class="p">}</span>

      <span class="nx">processNextWithDelay</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">getTermsByKana</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">indexedDBStorage_getTermsByKana</span><span class="p">(</span><span class="nx">syllablesStr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">homonymsArray</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">function</span> <span class="nx">doCallback</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>Check if the storage is ready.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isReady</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">doCallback</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">store</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_IDBDatabase</span><span class="p">.</span><span class="nx">transaction</span><span class="p">([</span><span class="s1">&#39;homonyms&#39;</span><span class="p">],</span> <span class="s1">&#39;readonly&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;homonyms&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">syllablesStr</span><span class="p">);</span>

      <span class="nx">req</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Database read error.&#39;</span><span class="p">);</span>
        <span class="nx">doCallback</span><span class="p">();</span>
      <span class="p">};</span>

      <span class="nx">req</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">homonyms</span> <span class="o">=</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">homonyms</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">homonymsArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">homonyms</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">doCallback</span><span class="p">();</span>
      <span class="p">};</span>
    <span class="p">},</span>
    <span class="cm">/* getTermsByKana */</span>

    <span class="nx">getTermsByKanaPrefix</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">indexedDBStorage_getTermsByKanaPrefix</span><span class="p">(</span>
                              <span class="nx">prefix</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">homonymsArray</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">function</span> <span class="nx">doCallback</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Check if the storage is ready.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isReady</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">doCallback</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">upperBound</span> <span class="o">=</span> <span class="nx">prefix</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
        <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">prefix</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">prefix</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">store</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_IDBDatabase</span><span class="p">.</span><span class="nx">transaction</span><span class="p">([</span><span class="s1">&#39;homonyms&#39;</span><span class="p">],</span> <span class="s1">&#39;readonly&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;homonyms&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span>
        <span class="nx">store</span><span class="p">.</span><span class="nx">openCursor</span><span class="p">(</span><span class="nx">IDBKeyRange</span><span class="p">.</span><span class="nx">bound</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">upperBound</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>

      <span class="nx">req</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Database read error.&#39;</span><span class="p">);</span>
        <span class="nx">doCallback</span><span class="p">();</span>
      <span class="p">};</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">homonyms</span> <span class="o">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
          <span class="nx">homonymsArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">homonyms</span><span class="p">);</span>
          <span class="nx">cursor</span><span class="p">.</span><span class="k">continue</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">doCallback</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p><em>* IMEngineDatabase is exposed to IME *</em>
It contains both instances of <code>jsonStorage</code> and <code>indexedDBStorage</code>
Query processes in indexedDBStorage if possible, otherwise in jsonStorage</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">IMEngineDatabase</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">imedb</span><span class="p">(</span><span class="nx">dbName</span><span class="p">,</span> <span class="nx">jsonUrl</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">settings</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>Dictionary words' total frequency.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">kDictTotalFreq</span> <span class="o">=</span> <span class="mf">1.0e8</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">jsonStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JsonStorage</span><span class="p">(</span><span class="nx">jsonUrl</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">indexedDBStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IndexedDBStorage</span><span class="p">(</span><span class="nx">dbName</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">iDBCache</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">cacheTimer</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">kCacheTimeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="cm">/* ==== init functions ==== */</span>
    <span class="kd">var</span> <span class="nx">populateDBFromJSON</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">imedb_populateDBFromJSON</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">jsonStorage</span><span class="p">.</span><span class="nx">getAllTerms</span><span class="p">(</span><span class="kd">function</span> <span class="nx">getAllTermsCallback</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">indexedDBStorage</span><span class="p">.</span><span class="nx">setAllTerms</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">};</span>

    <span class="cm">/* ==== helper functions ==== */</span>

    <span class="cm">/*</span>
<span class="cm">     * Data from IndexedDB gets to kept in iDBCache for kCacheTimeout seconds</span>
<span class="cm">     */</span>
    <span class="kd">var</span> <span class="nx">cacheSetTimeout</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">imedb_cacheSetTimeout</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Set iDBCache timeout.&#39;</span><span class="p">);</span>
      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">cacheTimer</span><span class="p">);</span>
      <span class="nx">cacheTimer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="nx">imedb_cacheTimeout</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Empty iDBCache.&#39;</span><span class="p">);</span>
        <span class="nx">iDBCache</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">},</span> <span class="nx">kCacheTimeout</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="cm">/* ==== init ==== */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">imedb_init</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">settings</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">ready</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Ready.&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">ready</span><span class="p">)</span>
          <span class="nx">settings</span><span class="p">.</span><span class="nx">ready</span><span class="p">();</span>
      <span class="p">};</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">enableIndexedDB</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;IndexedDB disabled; Downloading JSON ...&#39;</span><span class="p">);</span>
        <span class="nx">jsonStorage</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">ready</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Probing IndexedDB ...&#39;</span><span class="p">);</span>
      <span class="nx">indexedDBStorage</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="kd">function</span> <span class="nx">indexedDBStorageInitCallback</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">indexedDBStorage</span><span class="p">.</span><span class="nx">isReady</span><span class="p">())</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;IndexedDB not available; Downloading JSON ...&#39;</span><span class="p">);</span>
          <span class="nx">jsonStorage</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">ready</span><span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">ready</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">indexedDBStorage</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">())</span> <span class="p">{</span>
          <span class="nx">jsonStorage</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="kd">function</span> <span class="nx">jsonStorageInitCallback</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">jsonStorage</span><span class="p">.</span><span class="nx">isReady</span><span class="p">())</span> <span class="p">{</span>
              <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;JSON failed to download.&#39;</span><span class="p">);</span>
              <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">debug</span><span class="p">(</span>
              <span class="s1">&#39;JSON loaded,&#39;</span> <span class="o">+</span>
              <span class="s1">&#39;IME is ready to use while inserting data into db ...&#39;</span>
              <span class="p">);</span>
            <span class="nx">populateDBFromJSON</span><span class="p">(</span><span class="kd">function</span> <span class="nx">populateDBFromJSONCallback</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">indexedDBStorage</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">())</span> <span class="p">{</span>
                <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;IndexedDB ready and switched to indexedDB backend.&#39;</span><span class="p">);</span>
                <span class="nx">jsonStorage</span><span class="p">.</span><span class="nx">uninit</span><span class="p">();</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Failed to populate IndexedDB from JSON.&#39;</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">});</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">};</span>

    <span class="cm">/* ==== uninit ==== */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">uninit</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">imedb_uninit</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">indexedDBStorage</span><span class="p">.</span><span class="nx">uninit</span><span class="p">();</span>
      <span class="nx">jsonStorage</span><span class="p">.</span><span class="nx">uninit</span><span class="p">();</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>return instance of indexedDBStorage if possible
       otherwise jsonStorage
       null if neither is not available</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_getUsableStorage</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">imedb__getUsableStorage</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">enableIndexedDB</span> <span class="o">&amp;&amp;</span>
          <span class="nx">indexedDBStorage</span><span class="p">.</span><span class="nx">isReady</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
          <span class="o">!</span><span class="nx">indexedDBStorage</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">indexedDBStorage</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">jsonStorage</span><span class="p">.</span><span class="nx">isReady</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">jsonStorage</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">jsonStorage</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
    <span class="p">};</span>

    <span class="cm">/* ==== db lookup functions ==== */</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>syllables kana
textStr kanji
callback Function</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">getSuggestions</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">imedb_getSuggestions</span><span class="p">(</span><span class="nx">kanaStr</span><span class="p">,</span> <span class="nx">kanjiStr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;getSuggestions &#39;</span> <span class="o">+</span> <span class="nx">kanjiStr</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">kanaStr</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nx">_getUsableStorage</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">storage</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Database not ready.&#39;</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">([]);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="kd">var</span> <span class="nx">_matchTerm</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">getSuggestions_matchTerm</span><span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">term</span><span class="p">.</span><span class="nx">kanji</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">kanjiStr</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">kanjiStr</span><span class="p">)</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">term</span><span class="p">.</span><span class="nx">kanji</span> <span class="o">===</span> <span class="nx">kanjiStr</span><span class="p">)</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">term</span><span class="p">);</span>
      <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">_processResult</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">getSuggestions_processResult</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>r = r.sort(
function getSuggestions_sort(a, b) {
return (b.freq - a.freq);
}
);</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="nx">terms_foreach</span><span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">term</span><span class="p">.</span><span class="nx">kanji</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="nx">t</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">term</span><span class="p">.</span><span class="nx">kanji</span><span class="p">);</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">term</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
      <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Get suggestion for &#39;</span> <span class="o">+</span> <span class="nx">kanjiStr</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">iDBCache</span><span class="p">[</span><span class="s1">&#39;SUGGESTION:&#39;</span> <span class="o">+</span> <span class="nx">kanjiStr</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Found in iDBCache.&#39;</span><span class="p">);</span>
        <span class="nx">cacheSetTimeout</span><span class="p">();</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">iDBCache</span><span class="p">[</span><span class="s1">&#39;SUGGESTION:&#39;</span> <span class="o">+</span> <span class="nx">kanjiStr</span><span class="p">]);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>by prefix</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">storage</span><span class="p">.</span><span class="nx">getTermsByKanaPrefix</span><span class="p">(</span><span class="nx">kanaStr</span><span class="p">,</span>
        <span class="kd">function</span> <span class="nx">getTermsByKanaPrefix_callback</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">homonymsArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">homonyms</span> <span class="o">=</span> <span class="nx">homonymsArray</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">homonyms</span><span class="p">.</span><span class="nx">terms</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">_matchTerm</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">result</span> <span class="o">=</span> <span class="nx">_processResult</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span>
        <span class="nx">cacheSetTimeout</span><span class="p">();</span>
        <span class="nx">iDBCache</span><span class="p">[</span><span class="s1">&#39;SUGGESTION:&#39;</span> <span class="o">+</span> <span class="nx">kanjiStr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
      <span class="p">});</span>

    <span class="p">},</span>
    <span class="cm">/* end getSuggestions */</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">getTerms</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">imedb_getTerms</span><span class="p">(</span><span class="nx">kanaArr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nx">_getUsableStorage</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">storage</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Database not ready.&#39;</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">([]);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">kanaStr</span> <span class="o">=</span> <span class="nx">SyllableUtils</span><span class="p">.</span><span class="nx">arrayToString</span><span class="p">(</span><span class="nx">kanaArr</span><span class="p">);</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Get terms for &#39;</span> <span class="o">+</span> <span class="nx">kanaStr</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">_processResult</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">processResult</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">limit</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>r = r.sort(
function sort_result(a, b) {
return (b.freq - a.freq);
}
);</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">term</span><span class="p">.</span><span class="nx">kanji</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="nx">t</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">term</span><span class="p">.</span><span class="nx">kanji</span><span class="p">);</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">term</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">limit</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
      <span class="p">};</span>

      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">iDBCache</span><span class="p">[</span><span class="nx">kanaStr</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Found in iDBCache.&#39;</span><span class="p">);</span>
        <span class="nx">cacheSetTimeout</span><span class="p">();</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;cache &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">iDBCache</span><span class="p">[</span><span class="nx">kanaStr</span><span class="p">]));</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">iDBCache</span><span class="p">[</span><span class="nx">kanaStr</span><span class="p">]);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">storage</span><span class="p">.</span><span class="nx">getTermsByKana</span><span class="p">(</span><span class="nx">kanaStr</span><span class="p">,</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">homonymsArray</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">homonymsArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">homonyms</span> <span class="o">=</span> <span class="nx">homonymsArray</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">homonyms</span><span class="p">.</span><span class="nx">terms</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">_processResult</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="p">}</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Get terms getTermsByKana homonymsArray &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">));</span>
          <span class="nx">cacheSetTimeout</span><span class="p">();</span>
          <span class="nx">iDBCache</span><span class="p">[</span><span class="nx">kanaStr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">);</span>

    <span class="p">};</span>
    <span class="cm">/* end getTerms */</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">getTermWithHighestScore</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">imedb_getTermWithHighestScore</span><span class="p">(</span><span class="nx">syllables</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;getTermWithHighestScore &#39;</span> <span class="o">+</span> <span class="nx">syllables</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">getTerms</span><span class="p">(</span><span class="nx">syllables</span><span class="p">,</span>
        <span class="kd">function</span> <span class="nx">getTermsCallback</span><span class="p">(</span><span class="nx">terms</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">terms</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;no terms&#39;</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">);</span>
    <span class="p">};</span>
    <span class="cm">/* end getTermWithHighestScore */</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>sentence is a list of terms</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">getSentence</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">imedb_getSentence</span><span class="p">(</span><span class="nx">kanaStr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;getSentence &#39;</span> <span class="o">+</span> <span class="nx">kanaStr</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>TODO variable keeps the conposition of the best sentence
var </p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">doCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">getSentence_doCallback</span><span class="p">(</span><span class="nx">sentence</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;getSentence result &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">sentence</span><span class="p">));</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">sentence</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">kanaStr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">([]);</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">taskQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TaskQueue</span><span class="p">(</span>
        <span class="kd">function</span> <span class="nx">taskQueueOnCompleteCallback</span><span class="p">(</span><span class="nx">queueData</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">sentences</span> <span class="o">=</span> <span class="nx">queueData</span><span class="p">.</span><span class="nx">sentences</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">sentence</span> <span class="o">=</span> <span class="nx">sentences</span><span class="p">[</span><span class="nx">sentences</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
          <span class="nx">doCallback</span><span class="p">(</span><span class="nx">sentence</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">);</span>

      <span class="nx">taskQueue</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">sentences</span><span class="o">:</span> <span class="p">[[],</span> <span class="p">[]],</span>
        <span class="nx">probabilities</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="nx">sentenceLength</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">lastPhraseLength</span><span class="o">:</span> <span class="mi">1</span>
      <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">getSentenceSubTask</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">getSentence_subTask</span><span class="p">(</span><span class="nx">taskQueue</span><span class="p">,</span> <span class="nx">taskData</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">queueData</span> <span class="o">=</span> <span class="nx">taskQueue</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">sentenceLength</span> <span class="o">=</span> <span class="nx">queueData</span><span class="p">.</span><span class="nx">sentenceLength</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">lastPhraseLength</span> <span class="o">=</span> <span class="nx">queueData</span><span class="p">.</span><span class="nx">lastPhraseLength</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">sentences</span> <span class="o">=</span> <span class="nx">queueData</span><span class="p">.</span><span class="nx">sentences</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">probabilities</span> <span class="o">=</span> <span class="nx">queueData</span><span class="p">.</span><span class="nx">probabilities</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">probabilities</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">sentenceLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">probabilities</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">sentences</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">sentenceLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">sentences</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">maxProb</span> <span class="o">=</span> <span class="nx">probabilities</span><span class="p">[</span><span class="nx">sentenceLength</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">kanaStr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">sentenceLength</span> <span class="o">-</span>
            <span class="nx">lastPhraseLength</span><span class="p">,</span> <span class="nx">sentenceLength</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">getTermWithHighestScore</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span>
          <span class="kd">function</span> <span class="nx">getTermWithHighestScoreCallback</span><span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">syllable</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">term</span> <span class="o">=</span> <span class="p">{</span><span class="nx">kanji</span><span class="o">:</span> <span class="nx">syllable</span><span class="p">,</span> <span class="nx">freq</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">kana</span><span class="o">:</span> <span class="nx">syllable</span><span class="p">};</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">prob</span> <span class="o">=</span> <span class="nx">probabilities</span><span class="p">[</span><span class="nx">sentenceLength</span> <span class="o">-</span>
              <span class="nx">lastPhraseLength</span><span class="p">]</span> <span class="o">*</span> <span class="nx">term</span><span class="p">.</span><span class="nx">freq</span> <span class="o">/</span> <span class="nx">kDictTotalFreq</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">prob</span> <span class="o">&gt;</span> <span class="nx">probabilities</span><span class="p">[</span><span class="nx">sentenceLength</span><span class="p">])</span> <span class="p">{</span>
              <span class="nx">probabilities</span><span class="p">[</span><span class="nx">sentenceLength</span><span class="p">]</span> <span class="o">=</span> <span class="nx">prob</span><span class="p">;</span>
              <span class="nx">sentences</span><span class="p">[</span><span class="nx">sentenceLength</span><span class="p">]</span> <span class="o">=</span> 
                <span class="nx">sentences</span><span class="p">[</span><span class="nx">sentenceLength</span> <span class="o">-</span> <span class="nx">lastPhraseLength</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">term</span><span class="p">);</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>process next step</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">lastPhraseLength</span> <span class="o">&lt;</span> <span class="nx">sentenceLength</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">queueData</span><span class="p">.</span><span class="nx">lastPhraseLength</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">queueData</span><span class="p">.</span><span class="nx">lastPhraseLength</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">sentenceLength</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">queueData</span><span class="p">.</span><span class="nx">sentenceLength</span><span class="o">++</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">taskQueue</span><span class="p">.</span><span class="nx">processNext</span><span class="p">();</span>
                <span class="k">return</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">taskQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">getSentenceSubTask</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
            <span class="nx">taskQueue</span><span class="p">.</span><span class="nx">processNext</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">);</span>
      <span class="p">};</span>

      <span class="nx">taskQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">getSentenceSubTask</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="nx">taskQueue</span><span class="p">.</span><span class="nx">processNext</span><span class="p">();</span>
    <span class="p">};</span>
    <span class="cm">/* end getSentence */</span>
  <span class="p">};</span>
  <span class="cm">/* end IMEngineDatabase */</span>
<span class="p">})();</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 