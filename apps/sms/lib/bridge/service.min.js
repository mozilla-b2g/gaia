(function(p){"object"===typeof exports&&"undefined"!==typeof module?module.exports=p():"function"===typeof define&&define.amd?define([],p):("undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:this).bridge=p()})(function(){return function e(h,m,c){function l(f,b){if(!m[f]){if(!h[f]){var k="function"==typeof require&&require;if(!b&&k)return k(f,!0);if(n)return n(f,!0);k=Error("Cannot find module '"+f+"'");throw k.code="MODULE_NOT_FOUND",k;}k=m[f]={exports:{}};
h[f][0].call(k.exports,function(d){var a=h[f][1][d];return l(a?a:d)},k,k.exports,e,h,m,c)}return m[f].exports}for(var n="function"==typeof require&&require,g=0;g<c.length;g++)l(c[g]);return l}({1:[function(e,h,m){var c=h.exports=self.bridge||{};c.service=e("../src/service");"u"!="undefined"[0]?(void 0)([],function(){return c}):self.bridge=c},{"../src/service":5}],2:[function(e,h,m){function c(l){if(l)return Object.assign(l,c.prototype)}h.exports=c;c.prototype={on:function(c,e){this._callbacks||(this._callbacks=
{});this._callbacks[c]||(this._callbacks[c]=[]);this._callbacks[c].push(e);return this},off:function(c,e){if(this._callbacks)switch(arguments.length){case 0:this._callbacks={};break;case 1:delete this._callbacks[c];break;default:var g=this._callbacks[c];if(!g)return;var f=g.indexOf(e);~f&&g.splice(f,1)}return this},emit:function(c,e){if(this._callbacks)for(var g=this._callbacks[c]||[],g=g.concat(this._callbacks["*"]||[]),f=0;f<g.length;f++)g[f].call(this,e,c);return this}};e=c.prototype;e.off=e.off;
e.on=e.on},{}],3:[function(e,h,m){function c(a){this.cancelled=!1;this.listeners=[];this.deferred=b();this.listen=this.listen.bind(this);this.onMessage=this.onMessage.bind(this);this.onTimeout=this.onTimeout.bind(this);"object"===typeof a?this.setupInbound(a):this.setupOutbound(a);d("initialized",this.type)}function l(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this);d("receiver initialized",a)}function n(a,
d){d=[].slice.call(arguments,1);return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined",4:"timeout"}[a])}var g=e("./port-adaptors"),f=e("../emitter");e=e("../utils");var b=e.deferred,k=e.uuid;m=h.exports=function(a){return new c(a)};m.receiver=function(a,d){return new l(a,d)};m.Receiver=l;m.Message=c;var d={0:function(){},1:function(a){return performance.mark("["+self.constructor.name+"][Message] - "+a)},2:function(a,d){d=[].slice.call(arguments,
1);console.log.apply(console,[].concat(["[Message]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+a+'"'],d))}}[0];c.prototype={setupOutbound:function(a){this.id=k();this.type=a;this.sent=!1;this.recipient="*"},setupInbound:function(a){d("inbound");this.hasResponded=!1;this.setSourcePort(a.source||a.target);this.event=a;Object.assign(this,a.data)},setSourcePort:function(a){d("set source",a.constructor.name);this.sourcePort=g(a,{ready:!0});return this},set:function(a,b){d("set",a,b);
"object"==typeof a?Object.assign(this,a):this[a]=b;return this},serialize:function(){return{id:this.id,type:this.type,data:this.data,recipient:this.recipient,noRespond:this.noRespond}},preventDefault:function(){d("prevent default");this.defaultPrevented=!0},send:function(a){d("send",this.type);if(this.sent)throw n(1);var b=this.serialize(),c=!this.noRespond;this.port=a?g(a):this.port;if(!this.port)throw n(3);c?(this.listen(this.port),this.setResponseTimeout()):this.deferred.resolve();this.port.postMessage(b,
this.getTransfer());d("sent",b);return this.deferred.promise},setResponseTimeout:function(){!1!==this.timeout&&(this._timer=setTimeout(this.onTimeout,this.timeout||2E3))},clearResponseTimeout:function(){clearTimeout(this._timer)},getTransfer:function(){return this.transfer||this.event&&this.event.ports},onMessage:function(a){if(a.data.response&&a.data.id===this.id&&!this.cancelled)this.onResponse(a)},onTimeout:function(){d("response timeout",this.type);this.silentTimeout||this.deferred.reject(n(4));
this.teardown()},listen:function(a){d("add response listener",a);a=g(a);a.addListener(this.onMessage,this.listen);this.listeners.push(a);return this},unlisten:function(){var a=this;d("remove response listeners");this.listeners.forEach(function(d){return d.removeListener(a.onMessage)});this.listeners=[]},cancel:function(){this.teardown();this.cancelled=!0;this.emit("cancel")},teardown:function(){this.clearResponseTimeout();this.unlisten()},respond:function(a){function b(a){d("resolve",a);k({type:"resolve",
value:a})}function c(a){a:switch(a&&a.constructor.name){case "DOMException":case "Error":a={message:a.message};break a;case "DOMError":a={message:a.message,name:a.name};break a}d("reject",a);k({type:"reject",value:a})}function k(a){f.response=a;f.sourcePort.postMessage({id:f.id,response:a},f.transfer);d("responded with:",a)}d("respond",a,this.id);if(this.hasResponded)throw n(2);if(this.sourcePort&&!this.noRespond){this.hasResponded=!0;var f=this;this.error&&c(this.error);Promise.resolve(a).then(b,
c).catch(c)}},forward:function(a){var b=this;d("forward");return this.set("silentTimeout",!0).send(a).then(function(a){return b.respond(a.value)})},onResponse:function(a){d("on response",a.data);var b=a.data.response,c="reject"==b.type?b.value:b;b.event=a;this.response=b;this.teardown();this.deferred[this.response.type](c);this.emit("response",b)}};f(c.prototype);l.prototype={listen:function(a){d("listen");a=g(a||self,{receiver:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.listen),
this.ports.add(a),this},unlisten:function(){var a=this;d("unlisten");this.ports.forEach(function(d){return d.removeListener(a.onMessage)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.isRecipient(a.data.recipient)&&(d("receiver on message",a.data),a=new c(a),this.emit("message",a),!a.defaultPrevented))try{this.emit(a.type,a)}catch(b){throw a.error=b,a.respond(),b;}},isRecipient:function(a){return a==this.name||"*"==a||"*"==this.name},destroy:function(){this.unlisten();delete this.name;return this}};
f(l.prototype)},{"../emitter":2,"../utils":6,"./port-adaptors":4}],4:[function(e,h,m){function c(d){this.target=d}function l(d,a,b){d.addEventListener(a,b)}function n(d,a,b){a={data:a,source:self};b&&(a.ports=b);d.dispatchEvent(new MessageEvent("message",a))}var g=e("../utils").deferred;h.exports=function(d,a){if(!d)throw Error({1:"target is undefined"}[1]);if(d&&d.addListener)return d;var k=b[d.constructor.name];return k?k(d,a):new c(d,a)};var f=c.prototype={constructor:c,addListener:function(d){this.target.addEventListener("message",
d)},removeListener:function(d){this.target.removeEventListener("message",d)},postMessage:function(d,a){this.target.postMessage(d,a)}},b={HTMLIFrameElement:function(d){var a=k(d);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(b,c){a.then(function(){return n(d.contentWindow,b,c)})}}},BroadcastChannel:function(d,a){function b(){var a=g();d.postMessage("ready?");l(d,"message",function q(b){"ready"==
b.data&&(d.removeEventListener("message",q),a.resolve())});return a.promise}var c=a&&a.receiver,k=a&&a.ready,k=k||c?Promise.resolve():b();c&&(d.postMessage("ready"),l(d,"message",function(a){"ready?"==a.data&&d.postMessage("ready")}));return{target:d,addListener:f.addListener,removeListener:f.removeListener,postMessage:function(a,b){k.then(function(){return d.postMessage(a,b)})}}},Window:function(b,a){var c=a&&a.ready||b===parent||b===self,c=c?Promise.resolve():k(b);return{addListener:function(a){window.addEventListener("message",
a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(a,k){c.then(function(){return n(b,a,k)})}}},SharedWorker:function(b){b.port.start();return new c(b.port)},SharedWorkerGlobalScope:function(){var b=[];return{postMessage:function(){},addListener:function(a,c){this.onconnect=function(a){a=a.ports[0];b.push(a);a.start();c(a)};self.addEventListener("connect",this.onconnect)},removeListener:function(a){self.removeEventListener("connect",this.onconnect);b.forEach(function(b){b.close();
b.removeEventListener("message",a)})}}}},k=function(){if("undefined"!=typeof window){var b=window.opener||window.parent,a=new WeakSet;b!=self&&l(window,"DOMContentLoaded",function r(){window.removeEventListener("DOMContentLoaded",r);n(b,"load")});l(self,"message",function(b){return"load"==b.data&&a.add(b.source)});return function(b){var c=b.contentWindow||b;if(a.has(c)||c==window.parent)return Promise.resolve();var d=g();l(window,"message",function q(a){"load"==a.data&&a.source==c&&(window.removeEventListener("message",
q),d.resolve())});return d.promise}}}()},{"../utils":6}],5:[function(e,h,m){function c(b){if(!(this instanceof c))return new c(b);g.Receiver.call(this,b);this.clients={};this.methods={};this.on("_disconnect",this.onDisconnect.bind(this)).on("_connect",this.onConnect.bind(this)).on("_method",this.onMethod.bind(this)).on("_off",this.onOff.bind(this)).on("_on",this.onOn.bind(this));this.destroy=this.destroy.bind(this);f("initialized",b)}function l(b){var c=[].slice.call(arguments,1);return Error({4:'method "'+
c[0]+"\" doesn't exist"}[b])}var n=e("./utils").uuid,g=e("./message");e=g.Receiver;h.exports=c;var f={0:function(){},1:function(b){return performance.mark("["+self.constructor.name+"][Service] - "+b)},2:function(b,c){c=[].slice.call(arguments,1);console.log.apply(console,[].concat(["[Service]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+b+'"'],c))}}[0];c.prototype=Object.create(e.prototype);c.prototype.inWindow="Window"===constructor.name;c.prototype.method=function(b,c){this.methods[b]=
c;return this};c.prototype.broadcast=function(b,c,d){var a=this;f("broadcast",b,c,d);this.eachClient(function(e){if(!d||~d.indexOf(e.id))f("broadcasting to",e.id),a.push(b,c,e.id,{noRespond:!0})});return this};c.prototype.push=function(b,c,d,a){a=a&&a.noRespond;var f=this.getClient(d);return g("_push").set({recipient:d,noRespond:a,data:{type:b,data:c}}).send(f.port)};c.prototype.eachClient=function(b){for(var c in this.clients)b(this.clients[c])};c.prototype.getClient=function(b){return this.clients[b]};
c.prototype.onConnect=function(b){f("connection attempt",b.data,this.name);var c=b.data,d=c.clientId;d&&c.service===this.name&&!this.clients[d]&&(this.emit("before-connect",b),b.defaultPrevented||(this.upgradeChannel(b),this.addClient(d,b.sourcePort),b.respond(),this.emit("connected",d),f("connected",d)))};c.prototype.upgradeChannel=function(b){if(!this.inWindow||"Window"!==b.data.originEnv){var c=b.event.ports;if(c=c&&c[0])b.setSourcePort(c),this.listen(c),c.start();f("channel upgraded")}};c.prototype.onDisconnect=
function(b){var c=this.clients[b.data];c&&(this.emit("before-disconnect",b),b.defaultPrevented||(this.removeClient(c.id),b.respond(),this.emit("disconnected",c.id),f("disconnected",c.id)))};c.prototype.onMethod=function(b){f("on method",b.data);this.emit("before-method",b);if(!b.defaultPrevented){var c=b.data,d=c.name,a=this.methods[d],e;if(!a)throw l(4,d);try{e=a.apply(this,c.args)}catch(g){b.error=g}b.respond(e)}};c.prototype.onOn=function(b){f("on on",b.data);this.emit("on",b.data)};c.prototype.onOff=
function(b){f("on off");this.emit("off",b.data)};c.prototype.addClient=function(b,c){this.clients[b]={id:b,port:c}};c.prototype.removeClient=function(b){delete this.clients[b]};c.prototype.plugin=function(b){b(this,{uuid:n});return this};c.prototype.disconnect=function(b){this.removeClient(b.id);g("disconnect").set({recipient:b.id,noRespond:!0}).send(b.port)};c.prototype.destroy=function(){delete this.clients;this.unlisten();this.off()};h=c.prototype;h.broadcast=h.broadcast;h.destroy=h.destroy;h.method=
h.method;h.plugin=h.plugin},{"./message":3,"./utils":6}],6:[function(e,h,m){m.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var e=16*Math.random()|0;return("x"==c?e:e&3|8).toString(16)})};m.deferred=function(){var c={};c.promise=new Promise(function(e,h){c.resolve=e;c.reject=h});return c}},{}]},{},[1])(1)});
