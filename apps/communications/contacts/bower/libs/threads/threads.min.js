!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.threads=e()}}(function(){return function e(t,n,s){function i(a,o){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!o&&c)return c(a,!0);if(r)return r(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var d=n[a]={exports:{}};t[a][0].call(d.exports,function(e){var n=t[a][1][e];return i(n?n:e)},d,d.exports,e,t,n,s)}return n[a].exports}for(var r="function"==typeof require&&require,a=0;a<s.length;a++)i(s[a]);return i}({1:[function(require,module,exports){module.exports={create:require("./lib/child-thread"),manager:require("./lib/manager"),service:require("./lib/service"),client:require("./lib/client")}},{"./lib/child-thread":2,"./lib/client":3,"./lib/manager":6,"./lib/service":8}],2:[function(require,module,exports){"use strict";function e(i){if(!(this instanceof e))return new e(i);if(!t(i.type))throw n(3,i.type);this.id=r.uuid(),this.src=i.src,this.type=i.type,this.parentNode=i.parentNode,this.target=i.target||this.createTarget(),this.threadId=void 0,this.services={},this.onmessage=this.onmessage.bind(this),this.messenger=new s(this.id,"[ChildThread]").handle("redundant",this.onredundant,this).handle("serviceready",this.onserviceready,this),this.listen(),this.ready=this.checkReady()}function t(e){return!!~["window","worker","sharedworker"].indexOf(e)}function n(e){var t=[].slice.call(arguments,1);return new Error({1:"iframes can't be spawned from workers",2:'Request to get service "'+t[0]+'" timed out',3:'type "'+t[0]+"\" not recognized, must be: 'window', 'worker' or 'sharedworker'"}[e])}var s=require("./messenger"),i=require("./emitter"),r=require("./utils");module.exports=e;e.prototype=Object.create(i.prototype);var a=e.prototype;a.createTarget=function(){switch(this.type){case"worker":return new Worker(this.src);case"sharedworker":return new SharedWorker(this.src);case"window":if("window"!==r.env())throw n(1);var e=document.createElement("iframe");return(this.parentNode||document.body).appendChild(e),e.src=this.src,e}},a.getService=function(e){return this.ready.then(function(){return this._getService(e)}.bind(this))},a._getService=function(e){function t(n){n.name===e&&(a.off("serviceready",t),clearTimeout(o),i.resolve(n))}var s=this.services[e];if(s)return Promise.resolve(s);var i=r.deferred(),a=this;this.on("serviceready",t);var o=setTimeout(function(){a.off("serviceready",t),i.reject(n(2,e))},2e3);return i.promise},a.checkReady=function(){function e(e){n++||(s.messenger.unhandle("threadready"),s.threadId=e.id,s.services=e.services,t.resolve())}var t=r.deferred(),n=0,s=this;return this.messenger.request(this,{type:"ping"}).then(e),this.messenger.handle("threadready",e),t.promise},a.postMessage=function(e){switch(this.type){case"worker":this.target.postMessage(e);break;case"sharedworker":this.target.port.postMessage(e);break;case"window":if(!this.target.contentWindow)return;this.target.contentWindow.postMessage(e,"*")}},a.listen=function(){switch(this.type){case"worker":this.target.addEventListener("message",this.onmessage);break;case"sharedworker":this.target.port.start(),this.target.port.addEventListener("message",this.onmessage);break;case"window":addEventListener("message",this.onmessage)}},a.unlisten=function(){switch(this.type){case"worker":this.target.removeEventListener("message",this.onmessage);break;case"sharedworker":this.target.port.close(),this.target.port.removeEventListener("message",this.onmessage);break;case"window":removeEventListener("message",this.onmessage)}},a.onmessage=function(e){this.fromTarget(e)&&(this.messenger.parse(e),this.emit("message",e))},a.fromTarget=function(e){return e.target===this.target||this.target.contentWindow===e.source||e.target===this.target.port},a.onserviceready=function(e){this.services[e.name]=e,this.emit("serviceready",e)},a.onredundant=function(){this.emit("redundant")},a.destroy=function(){this.unlisten(),this.destroyTarget(),this.off()},a.destroyTarget=function(){switch(this.type){case"worker":this.target.terminate();break;case"sharedworker":this.target.port.close();break;case"window":this.target.remove()}delete this.target}},{"./emitter":5,"./messenger":7,"./utils":11}],3:[function(require,module,exports){"use strict";function e(t,n){return this instanceof e?(this.contract=n&&n.contract,this.thread=n&&n.thread,this.id=r.uuid(),this._activeStreams={},this._connected=!1,this.service={channel:void 0,name:t,id:void 0},this.messenger=new s(this.id,"client").handle("streamevent",this.onstreamevent,this).handle("broadcast",this.onbroadcast,this),void this.connect()):new e(t,n)}var t=require("../thread-global"),n=require("./stream"),s=require("../messenger"),i=require("../emitter"),r=require("../utils");module.exports=e;var a=new BroadcastChannel("threadsmanager");e.prototype=Object.create(i.prototype);var o=e.prototype;o.connect=function(){if(this.connected)return this.connected;var e=this;return this.service.channel=new BroadcastChannel(this.id),this.service.channel.onmessage=this.messenger.parse,this.connected=this.thread?this.connectViaThread():this.connectViaManager(),this.connected.then(function(n){e.service.id=n.id,t.connection("outbound")})},o.connectViaThread=function(){var e=this;return this.thread.getService(e.service.name).then(function(t){return e.thread.on("message",e.messenger.parse),e.messenger.request(e.thread,{type:"connect",recipient:t.id,data:{client:e.id,service:t.name,contract:e.contract}})}).then(function(t){return e.thread.off("message",e.messenger.parse),t})},o.connectViaManager=function(){var e=this.messenger.parse;return a.addEventListener("message",e),this.messenger.request(a,{type:"connect",recipient:"*",data:{service:this.service.name,client:this.id}}).then(function(t){return a.removeEventListener("message",e),t})},o.disconnect=function(){return this.connected?this.request("disconnect",this.id).then(function(){this.service.channel.close(),delete this.service.channel,delete this.service.id,delete this.connected,t.disconnection("outbound")}.bind(this)):Promise.resolve()},o.request=function(e,t){return this.connect().then(function(){return this.messenger.request(this.service.channel,{type:e,recipient:this.service.id,data:t})}.bind(this))},o.onbroadcast=function(e){this.emit(e.type,e.data)},o.method=function(e){var t=[].slice.call(arguments,1);return this.request("method",{name:e,args:t})},o.stream=function(e){var t=[].slice.call(arguments,1),s=this,i=r.uuid(),a=new n({id:i,client:this});return this._activeStreams[i]=a,this.request("stream",{name:e,args:t,id:i})["catch"](function(e){s.onstreamevent({type:"abort",id:i,data:e})}),a},o.onstreamevent=function(e){var t=e.id,n=e.type,s=this._activeStreams[t];s._[n](e.data),("abort"===n||"close"===n)&&delete this._activeStreams[t]}},{"../emitter":5,"../messenger":7,"../thread-global":10,"../utils":11,"./stream":4}],4:[function(require,module,exports){"use strict";function e(e){this._=new t(e)}function t(e){this.id=e.id,this.client=e.client,this.closed=s.deferred(),this.emitter=new n}var n=require("../emitter"),s=require("../utils");module.exports=e;var i=e.prototype;Object.defineProperty(i,"closed",{get:function(){return this._.closed.promise}}),i.listen=function(e){this._.emitter.on("write",e)},i.unlisten=function(e){this._.emitter.off("write",e)},i.cancel=function(e){var t=s.deferred(),n=this._.client,i=this._.id;return n.request("streamcancel",{id:i,reason:e}).then(function(e){delete n._activeStreams[i],t.resolve(e)})["catch"](function(e){delete n._activeStreams[i],t.reject(e)}),t.promise};var r=t.prototype;r.abort=function(e){this.closed.reject(e)},r.close=function(){this.closed.resolve()},r.write=function(e){this.emitter.emit("write",e)}},{"../emitter":5,"../utils":11}],5:[function(require,module,exports){"use strict";function e(){}module.exports=e;var t=e.prototype;t.on=function(e,t){return this._callbacks||(this._callbacks={}),this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(t),this},t.off=function(e,t){if(this._callbacks)switch(arguments.length){case 0:this._callbacks={};break;case 1:delete this._callbacks[e];break;default:var n=this._callbacks[e];if(!n)return;var s=n.indexOf(t);~s&&n.splice(s,1)}return this},t.emit=function(e,t){if(this._callbacks){var n=this._callbacks[e]||[];n=n.concat(this._callbacks["*"]||[]);for(var s=0;s<n.length;s++)n[s].call(this,t,e)}return this}},{}],6:[function(require,module,exports){"use strict";function e(n){return this instanceof e?void(this._=new t(n)):new e(n)}function t(e){this.id="threadsmanager",this.registry={},this.threads={},this.messenger=new s(this.id,"[Manager]").handle("connect",this.onconnect,this),r.addEventListener("message",this.messenger.parse),this.register(e)}var n=require("./child-thread"),s=require("./messenger");module.exports=e;var i=function(){},r=new BroadcastChannel("threadsmanager"),a=e.prototype;a.destroy=function(){this._.destroy()};var o=t.prototype;o.destroy=function(){this.destroyed||(r.removeEventListener("message",this.messenger.parse),this.destroyThreads(),delete this.registry,delete this.threads,this.destroyed=!0)},o.destroyThreads=function(){for(var e in this.threads)this.destroyThread(this.threads[e])},o.register=function(e){for(var t in e)e[t].name=t,this.registry[t]=e[t]},o.onconnect=function(e){var t=e.data,n=this.registry[t.service];if(!n)return i('"%s" not managed here',t.service);var s=this,r=t.client,a=n.contract,o=this.getThread(n);e.respond(o.getService(n.name).then(function(e){return s.connect(r,e,a)}))},o.connect=function(e,t,n){return this.messenger.request(r,{type:"connect",recipient:t.id,data:{client:e,service:t.name,contract:n}})},o.getThread=function(e){var t=this.threads[e.src];return t||this.createThread(e)},o.createThread=function(e){var t=new n(e),s=this;return this.threads[t.src]=t,t.on("redundant",function i(){t.off("redundant",i),s.destroyThread(t)}),t},o.destroyThread=function(e){e.destroy(),delete this.threads[e.src]}},{"./child-thread":2,"./messenger":7}],7:[function(require,module,exports){"use strict";function e(e,t){this.id=e,this.name=t,this.handlers={},this.pending={},this.history=new Array(10),this.parse=this.parse.bind(this)}function t(e){var t=e.data,n=t.data;this.id=n.id,this.channel=e.source||e.target,this.sender=t.sender,this.type=n.type,this.data=n.data,this.responded=!1}function n(e,t){var n="Window"===e.constructor.name,i={type:t.type,id:s.uuid(),recipient:t.recipient||"*",sender:t.sender,data:t.data};n?e.postMessage(i,"*"):e.postMessage(i)}var s=require("./utils"),i=function(){};module.exports=e;var r=e.prototype;r.handle=function(e,t,n){return this.handlers[e]={fn:t,ctx:n},this},r.unhandle=function(e){return delete this.handlers[e],this},r.parse=function(e){var t=e.data;if(this.isRecipient(t)&&!this.hasRead(t)){var n=this["on"+t.type];n&&(n.call(this,e),this.read(t))}},r.request=function(e,t){var i=s.deferred(),r=s.uuid();return n(e,{type:"request",sender:this.id,recipient:t.recipient,data:{id:r,type:t.type,data:t.data}}),this.pending[r]=i,i.promise},r.push=function(e,t){n(e,{type:"push",sender:this.id,recipient:t.recipient,data:{type:t.type,data:t.data}})},r.onrequest=function(e){var n=new t(e),s=this.handlers[n.type];if(s)try{s.fn.call(s.ctx,n)}catch(e){n.respond(e)}},r.onresponse=function(e){var t=e.data,n=t.data,s=n.request,r=this.pending[s];if(!r)return i("no promise",this.pending);var a=n.result,o={fulfilled:"resolve",rejected:"reject"}[a.state],c=a.reason||a.value;r[o](c),delete this.pending[s]},r.onpush=function(e){var t=e.data,n=t.data,s=this.handlers[n.type];s&&s.fn.call(s.ctx,n.data)},r.isRecipient=function(e){var t=e.recipient;return t===this.id||"*"===t},r.read=function(e){this.history.push(e.id),this.history.shift()},r.hasRead=function(e){return!!~this.history.indexOf(e.id)},t.prototype.respond=function(e){function t(e){i({state:"fulfilled",value:e})}function s(e){i({state:"rejected",reason:e.message||e})}function i(e){n(r.channel,{type:"response",recipient:r.sender,data:{request:r.id,result:e}})}if(!this.responded){this.responded=!0;var r=this;return e instanceof Error&&s(e),Promise.resolve(e).then(t,s)["catch"](s)}}},{"./utils":11}],8:[function(require,module,exports){"use strict";function e(n){return this instanceof e?(this.name=n,void(this["private"]=new t(this))):new e(n)}function t(e){this["public"]=e,this.name=e.name,this.id=a.uuid(),this.contract=null,this.methods={},this.channels={},this.streams={},this.activeStreams={},this.messenger=new i(this.id,"[Service]").handle("connect",this.onconnect,this).handle("stream",this.onstream,this).handle("streamcancel",this.onstreamcancel,this).handle("method",this.onmethod,this).handle("disconnect",this.ondisconnect,this),this.listen(),setTimeout(this.ready.bind(this))}function n(e){var t=[].slice.call(arguments,1);return new Error({1:'method "'+t[0]+'" not defined in the contract',2:'expected method " '+t[0]+'" to be called with '+t[1]+" arguments",3:'unknown request type: "'+t[0]+'"',4:'method "'+t[0]+"\" doesn't exist",5:"arguments types don't match contract",6:'stream "'+t[0]+"\" doesn't exist"}[e])}var s=require("../thread-global"),i=require("../messenger"),r=require("./stream"),a=require("../utils");exports=module.exports=e,exports.Stream=r;var o=new BroadcastChannel("threadsmanager"),c=e.prototype;c.method=function(e,t){return this["private"].addMethod(e,t),this},c.stream=function(e,t){return this["private"].addStream(e,t),this},c.contract=function(e){return this["private"].setContract(e),this},c.broadcast=function(e,t,n){return this["private"].broadcast(e,t,n),this};var h=t.prototype;h.onmethod=function(e){var t=e.data,s=this.methods[t.name];if(!s)throw n(4,t.name);this.checkMethodCall(t);var i=s.apply(this["public"],t.args);e.respond(i)},h.onstream=function(e){var t=e.data,s=this.streams[t.name],i=e.sender;if(!s)throw n(6,t.name);var a=t.id,o=new r({id:a,channel:this.channels[i],serviceId:this.id,clientId:i});this.activeStreams[a]=o,s.apply(this["public"],[o].concat(t.args)),e.respond()},h.onstreamcancel=function(e){var t=e.data,n=t.id,s=this.activeStreams[n];delete this.activeStreams[n],e.respond(s._.cancel(t.reason))},h.ready=function(){s.serviceReady(this)},h.onconnect=function(e){var t=e.data,n=t.client,i=t.contract,r=t.service;if(n&&r===this.name&&!this.channels[n]){var a=new BroadcastChannel(n);a.onmessage=this.messenger.parse,this.channels[n]=a,this.setContract(i),s.connection("inbound"),e.respond({id:this.id,name:this.name})}},h.ondisconnect=function(e){var t=e.data;if(this.channels[t]){var n=a.deferred();n.resolve(),n.promise.then(function(){return e.respond()}).then(function(){this.channels[t].close(),delete this.channels[t],s.disconnection("inbound")}.bind(this))}},h.setContract=function(e){e&&(this.contract=e)},h.addMethod=function(e,t){this.methods[e]=t},h.addStream=function(e,t){this.streams[e]=t},h.checkMethodCall=function(e){var t=e.name,s=e.args;if(this.contract){var i,r=this.contract.methods[t];if(r?s.length!==r.length?i=n(2,t,r.length):a.typesMatch(s,r)||(i=n(5)):i=n(1,t),i)throw i}},h.listen=function(){o.addEventListener("message",this.messenger.parse),s.on("message",this.messenger.parse)},h.broadcast=function(e,t,n){for(var s in this.channels)(!n||~n.indexOf(s))&&this.messenger.push(this.channels[s],{type:"broadcast",recipient:s,data:{type:e,data:t}})}},{"../messenger":7,"../thread-global":10,"../utils":11,"./stream":9}],9:[function(require,module,exports){"use strict";function e(e){this._=new t(this,e)}function t(e,t){this.target=e,this.id=t.id,this.channel=t.channel,this.client=t.clientId,this.state="writable",this.messenger=new n(t.serviceId,"[ServiceStream]")}var n=require("../messenger");module.exports=e;var s=e.prototype;s.cancel=function(e){var t=new TypeError("service should implement stream.cancel()");return Promise.reject(t)},s.abort=function(e){return this._.post("abort","aborted",e)},s.write=function(e){return this._.post("write","writable",e)},s.close=function(){return this._.post("close","closed")};var i=t.prototype;i.validateState=function(e,t){if("writable"!==this.state){var n="Can't "+e+" on current state: "+this.state;return Promise.reject(new TypeError(n))}return this.state=t,Promise.resolve()},i.cancel=function(e){return this.validateState("cancel","canceled").then(function(){return this.target.cancel(e)}.bind(this))},i.post=function(e,t,n){return this.validateState(e,t).then(function(){this.messenger.push(this.channel,{type:"streamevent",recipient:this.client,data:{id:this.id,type:e,data:n}})}.bind(this))}},{"../messenger":7}],10:[function(require,module,exports){"use strict";function e(){this.id=a.uuid(),this.type=a.env(),this.isRoot=t(),this.manager=new BroadcastChannel("threadsmanager"),this.ports=[],this.services={},this.connections={inbound:0,outbound:0},this.messenger=new i(this.id,"[ThreadGlobal]").handle("ping",this.onPing,this),this.onmessage=this.onmessage.bind(this),this.listen(),this.ready()}function t(){return n()&&window.parent===window}function n(){return"undefined"!=typeof window}function s(e){var t=[].slice.call(arguments,1);return new Error({1:'Unknown connection type: "'+t[0]+'"',2:'Service "'+t[0]+'"already defined'}[e])}var i=require("./messenger"),r=require("./emitter"),a=require("./utils");e.prototype=Object.create(r.prototype);var o=e.prototype;o.listen=function(){switch(this.type){case"sharedworker":addEventListener("connect",function(e){var t=e.ports[0];this.ports.push(t),t.onmessage=this.onmessage,t.start()}.bind(this));break;case"worker":case"window":addEventListener("message",this.onmessage)}},o.ready=function(){this.isRoot||this.messenger.push(this,{type:"threadready",data:this.serialize()})},o.onPing=function(e){e.respond(this.serialize())},o.serialize=function(){return{id:this.id,services:this.services}},o.onmessage=function(e){this.messenger.parse(e),this.emit("message",e)},o.serviceReady=function(e){if(this.services[e.name])throw s(2,e.name);this.services[e.name]={id:e.id,name:e.name},this.messenger.push(this,{type:"serviceready",data:this.services[e.name]})},o.postMessage=function(e){switch(this.type){case"worker":postMessage(e);break;case"sharedworker":this.ports.forEach(function(t){t.postMessage(e)});break;case"window":window.parent.postMessage(e,"*")}},o.connection=function(e){if(!(e in this.connections))throw s(1,e);this.connections[e]++,this.check()},o.disconnection=function(e){if(!(e in this.connections))throw s(1,e);this.connections[e]--,this.check()},o.check=function(){this.isRedundant()&&this.messenger.push(this,{type:"redundant"})},o.isRedundant=function(){return!this.isRoot&&this.isDetached()},o.isDetached=function(){return!this.connections.inbound},module.exports=new e},{"./emitter":5,"./messenger":7,"./utils":11}],11:[function(require,module,exports){"use strict";exports.uuid=function(){for(var e=[],t=0;256>t;t++)e[t]=(16>t?"0":"")+t.toString(16);return function(){var t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,s=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]+"-"+e[255&n]+e[n>>8&255]+"-"+e[n>>16&15|64]+e[n>>24&255]+"-"+e[63&s|128]+e[s>>8&255]+"-"+e[s>>16&255]+e[s>>24&255]+e[255&i]+e[i>>8&255]+e[i>>16&255]+e[i>>24&255]}}(),exports.typesMatch=function(e,t){for(var n=0,s=e.length;s>n;n++)if(typeof e[n]!==t[n])return!1;return!0},exports.deferred=function(){var e={};return e.promise=new Promise(function(t,n){e.resolve=t,e.reject=n}),e},exports.query=function(e){var t={};return e.replace("?","").split("&").forEach(function(e){var n=e.split("=");t[n[0]]=n[1]}),t},exports.env=function(){return{Window:"window",SharedWorkerGlobalScope:"sharedworker",DedicatedWorkerGlobalScope:"worker",ServiceWorkerGlobalScope:"serviceworker"}[self.constructor.name]||"unknown"}},{}]},{},[1])(1)});